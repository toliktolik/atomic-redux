/*
 * Function: DirectX_ClearSurface
 * Address: 0047d420
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


uint __thiscall DirectX_ClearSurface(void *this,uint param_1)

{
  int iVar1;
  int *piVar2;
  byte *pbVar3;
  undefined1 *puVar4;
  locale *plVar5;
  facet *pfVar6;
  uint uVar7;
  uint uVar8;
  ios_base *this_00;
  undefined4 *puVar9;
  int local_1c;
  void *local_18;
  undefined1 *local_14;
  void *pvStack_10;
  undefined4 uStack_c;
  undefined4 local_8;
  
  local_8 = 0xffffffff;
  uStack_c = 0x5146f8;
  pvStack_10 = ExceptionList;
                    /* WARNING: Load size is inaccurate */
  this_00 = (ios_base *)(*(int *)(*this + 4) + (int)this);
  local_14 = &stack0xffffffd8;
  ExceptionList = &pvStack_10;
  local_18 = this;
  puVar4 = &stack0xffffffd8;
  if (*(int *)(*(int *)(*this + 4) + 4 + (int)this) == 0) {
    ExceptionList = &pvStack_10;
    puVar4 = &stack0xffffffd8;
    if (*(int **)(this_00 + 0x2c) != (int *)0x0) {
      ExceptionList = &pvStack_10;
      Stream_ReadCharacter(*(int **)(this_00 + 0x2c));
      puVar4 = local_14;
    }
    local_14 = puVar4;
                    /* WARNING: Load size is inaccurate */
    if (((char)param_1 == '\0') && ((*(uint *)(*(int *)(*this + 4) + 0xc + (int)this) & 1) != 0)) {
      plVar5 = (locale *)
               SexyWidget_ProcessInput((void *)(*(int *)(*this + 4) + (int)this),(int *)&param_1);
      local_8 = 0;
      pfVar6 = Memory_CopyImageBuffer(plVar5);
      uVar7 = param_1;
      local_8 = 0xffffffff;
      if (param_1 != 0) {
        Threading_LockSectorByIndex(&local_1c,0);
        iVar1 = *(int *)(uVar7 + 4);
        if ((iVar1 != 0) && (iVar1 != -1)) {
          *(int *)(uVar7 + 4) = iVar1 + -1;
        }
        puVar9 = (undefined4 *)(uVar7 & (*(int *)(uVar7 + 4) != 0) - 1);
        Threading_UnlockSectorByIndex(&local_1c);
        if (puVar9 != (undefined4 *)0x0) {
          (**(code **)*puVar9)(1);
        }
      }
                    /* WARNING: Load size is inaccurate */
      piVar2 = *(int **)(*(int *)(*this + 4) + 0x28 + (int)this);
      pbVar3 = *(byte **)piVar2[8];
      local_8 = 1;
      if ((pbVar3 == (byte *)0x0) || (pbVar3 + *(int *)piVar2[0xc] <= pbVar3)) {
        uVar7 = (**(code **)(*piVar2 + 0x10))();
      }
      else {
        uVar7 = (uint)*pbVar3;
      }
      while( true ) {
        if (uVar7 == 0xffffffff) {
                    /* WARNING: Load size is inaccurate */
          iVar1 = *(int *)(*this + 4);
          uVar7 = *(uint *)(iVar1 + 4 + (int)this);
          uVar8 = uVar7 | 1;
          if (*(int *)(iVar1 + 0x28 + (int)this) == 0) {
            uVar8 = uVar7 | 5;
          }
          std::ios_base::clear((ios_base *)(iVar1 + (int)this),uVar8,false);
          uVar7 = Exception_HandleDirectXError();
          return uVar7;
        }
        if ((*(byte *)(*(int *)(pfVar6 + 0x10) + (uVar7 & 0xff) * 2) & 0x48) == 0) break;
                    /* WARNING: Load size is inaccurate */
        uVar7 = DirectX_FillSurface(*(int **)(*(int *)(*this + 4) + 0x28 + (int)this));
      }
    }
                    /* WARNING: Load size is inaccurate */
    this_00 = (ios_base *)(*(int *)(*this + 4) + (int)this);
    puVar4 = local_14;
    if (*(int *)(this_00 + 4) == 0) {
      ExceptionList = pvStack_10;
      return 1;
    }
  }
  local_14 = puVar4;
  local_8 = 0xffffffff;
  uVar7 = *(uint *)(this_00 + 4) | 2;
  if (*(int *)(this_00 + 0x28) == 0) {
    uVar7 = *(uint *)(this_00 + 4) | 6;
  }
  std::ios_base::clear(this_00,uVar7,false);
  ExceptionList = pvStack_10;
  return uVar7 & 0xffffff00;
}


