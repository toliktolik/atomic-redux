/*
 * Function: GIF_OptimizePalette
 * Address: 004d3650
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


uint * __cdecl GIF_OptimizePalette(int param_1,int param_2,int param_3)

{
  uint uVar1;
  uint *puVar2;
  int iVar3;
  uint uVar4;
  int iVar5;
  int iVar6;
  uint *puVar7;
  uint local_90 [33];
  int local_c;
  uint *local_8;
  
  iVar5 = param_3;
  if (param_3 == 0) {
    iVar5 = param_2;
  }
  puVar2 = (uint *)_malloc(iVar5 << 2);
  puVar7 = local_90;
  for (iVar5 = 0x21; iVar5 != 0; iVar5 = iVar5 + -1) {
    *puVar7 = 0;
    puVar7 = puVar7 + 1;
  }
  iVar5 = 0;
  local_8 = puVar2;
  if (0 < param_2) {
    do {
      iVar6 = *(int *)(param_1 + iVar5 * 4);
      if (iVar6 < 1) {
        if (param_3 == 0) {
          puVar2 = puVar2 + 1;
        }
      }
      else {
        uVar4 = local_90[iVar6];
        if ((iVar6 < 0x20) && (uVar4 >> ((byte)iVar6 & 0x1f) != 0)) {
                    /* WARNING: Subroutine does not return */
          System_ShutdownHandler(iVar6,(uint)local_8);
        }
        *puVar2 = uVar4;
        puVar2 = puVar2 + 1;
        iVar3 = iVar6;
        do {
          if ((local_90[iVar3] & 1) != 0) {
            if (iVar3 == 1) {
              local_90[1] = local_90[1] + 1;
            }
            else {
              local_90[iVar3] = local_90[iVar3 + -1] << 1;
            }
            break;
          }
          local_90[iVar3] = local_90[iVar3] + 1;
          iVar3 = iVar3 + -1;
        } while (0 < iVar3);
        while ((iVar3 = iVar6 + 1, iVar3 < 0x21 && (uVar1 = local_90[iVar3], uVar1 >> 1 == uVar4)))
        {
          local_90[iVar3] = local_90[iVar6] << 1;
          uVar4 = uVar1;
          iVar6 = iVar3;
        }
      }
      iVar5 = iVar5 + 1;
    } while (iVar5 < param_2);
  }
  local_c = 0;
  puVar7 = local_8;
  if (0 < param_2) {
    do {
      iVar5 = *(int *)(param_1 + local_c * 4);
      uVar4 = 0;
      iVar6 = 0;
      if (0 < iVar5) {
        do {
          uVar4 = uVar4 * 2 | *puVar7 >> ((byte)iVar6 & 0x1f) & 1;
          iVar6 = iVar6 + 1;
        } while (iVar6 < iVar5);
      }
      if ((param_3 == 0) || (iVar5 != 0)) {
        *puVar7 = uVar4;
        puVar7 = puVar7 + 1;
      }
      local_c = local_c + 1;
    } while (local_c < param_2);
  }
  return local_8;
}


