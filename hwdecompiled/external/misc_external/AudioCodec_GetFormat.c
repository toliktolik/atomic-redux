/*
 * Function: AudioCodec_GetFormat
 * Address: 004b4b30
 * Category: audio
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __fastcall AudioCodec_GetFormat(int param_1,undefined2 param_2,int param_3)

{
  int *piVar1;
  short sVar2;
  undefined4 *puVar3;
  ushort uVar4;
  undefined4 extraout_ECX;
  int iVar5;
  int extraout_ECX_00;
  int extraout_ECX_01;
  undefined4 extraout_ECX_02;
  int extraout_ECX_03;
  undefined2 extraout_DX;
  uint uVar6;
  int iVar7;
  char *pcVar8;
  uint uVar9;
  char *pcVar10;
  bool bVar11;
  undefined8 uVar12;
  undefined6 uVar13;
  uint unaff_retaddr;
  undefined4 *in_stack_ffffffa8;
  undefined4 *in_stack_ffffffac;
  char local_34 [4];
  undefined1 local_30;
  undefined4 local_2c;
  undefined1 local_28 [4];
  undefined4 *local_24;
  undefined4 *local_20;
  uint local_1c;
  uint local_18;
  uint local_14;
  uint local_10;
  uint local_c;
  uint local_8;
  
  local_8 = DAT_00569f5c ^ unaff_retaddr;
  local_24 = (undefined4 *)param_1;
  uVar13 = String_AllocateBuffer(param_1,param_2);
  if ((int)uVar13 == 0) {
    Exception_SetMessage((void *)(local_8 ^ unaff_retaddr),in_stack_ffffffa8,in_stack_ffffffac);
    return;
  }
  local_30 = 0;
  Memory_GetHeapInfo(extraout_ECX,(short)((uint6)uVar13 >> 0x20));
  iVar5 = 5;
  bVar11 = true;
  pcVar8 = local_34;
  pcVar10 = ".snd";
  do {
    if (iVar5 == 0) break;
    iVar5 = iVar5 + -1;
    bVar11 = *pcVar8 == *pcVar10;
    pcVar8 = pcVar8 + 1;
    pcVar10 = pcVar10 + 1;
  } while (bVar11);
  if (bVar11) {
    Memory_GetHeapInfo(iVar5,0);
    local_14 = (local_14 & 0xff0000 | local_14 >> 0x10) >> 8 |
               (local_14 & 0xff00 | local_14 << 0x10) << 8;
    Memory_GetHeapInfo(local_14,0);
    local_c = (local_c & 0xff0000 | local_c >> 0x10) >> 8 |
              (local_c & 0xff00 | local_c << 0x10) << 8;
    Memory_GetHeapInfo(local_c,0);
    local_18 = (local_18 & 0xff0000 | local_18 >> 0x10) >> 8 |
               (local_18 & 0xff00 | local_18 << 0x10) << 8;
    Memory_GetHeapInfo(local_18,0);
    local_10 = (local_10 & 0xff0000 | local_10 >> 0x10) >> 8 |
               (local_10 & 0xff00 | local_10 << 0x10) << 8;
    Memory_GetHeapInfo(local_10,0);
    uVar6 = (local_1c & 0xff00 | local_1c << 0x10) << 8;
    uVar9 = local_1c >> 0x18;
    local_1c = (local_1c & 0xff0000 | local_1c >> 0x10) >> 8 | uVar6;
    Memory_DefragmentHeap((char)uVar9,uVar6);
    bVar11 = false;
    if (local_18 == 1) {
      iVar5 = 0x10;
      bVar11 = true;
    }
    else {
      if (local_18 != 2) goto LAB_004b4d9a;
      iVar5 = 8;
    }
    uVar9 = iVar5 * local_c >> 3;
    *(uint *)((int)local_24 + 0x408 + param_3 * 4) = uVar9;
    puVar3 = (undefined4 *)((int)local_24 + 4 + param_3 * 4);
    in_stack_ffffffa8 = (undefined4 *)0x14;
    in_stack_ffffffac = (undefined4 *)0x80ea;
    uVar12 = (**(code **)(**(int **)((int)local_24 + 0x1494) + 0xc))
                       (*(int **)((int)local_24 + 0x1494),&stack0xffffffa8,puVar3,0);
    iVar7 = (int)((ulonglong)uVar12 >> 0x20);
    iVar5 = extraout_ECX_00;
    if ((int)uVar12 == 0) {
      piVar1 = (int *)*puVar3;
      uVar12 = (**(code **)(*piVar1 + 0x2c))(piVar1,0,uVar9,&local_20,local_28,0,0,0);
      iVar7 = (int)((ulonglong)uVar12 >> 0x20);
      iVar5 = extraout_ECX_01;
      if ((int)uVar12 == 0) {
        puVar3 = (undefined4 *)operator_new(local_c);
        local_24 = puVar3;
        uVar12 = Memory_GetHeapInfo(extraout_ECX_02,extraout_DX);
        local_2c = (undefined4)uVar12;
        Memory_AllocateBlock(extraout_ECX_03,(int)((ulonglong)uVar12 >> 0x20));
        if (bVar11) {
          uVar9 = 0;
          if (local_c != 0) {
            do {
              uVar4 = *(byte *)(uVar9 + (int)puVar3) | 0x80;
              if (uVar4 < 0xf0) {
                if (uVar4 < 0xe0) {
                  if (uVar4 < 0xd0) {
                    if (uVar4 < 0xc0) {
                      if (uVar4 < 0xb0) {
                        if (uVar4 < 0xa0) {
                          if (uVar4 < 0x90) {
                            if (uVar4 < 0x81) {
                              sVar2 = 0xff;
                            }
                            else {
                              sVar2 = uVar4 * -0x100 + -0x6120;
                            }
                          }
                          else {
                            sVar2 = uVar4 * -0x80 + 0x5760;
                          }
                        }
                        else {
                          sVar2 = uVar4 * -0x40 + 0x2fa0;
                        }
                      }
                      else {
                        sVar2 = (0xce - uVar4) * 0x20;
                      }
                    }
                    else {
                      sVar2 = (0xdd - uVar4) * 0x10;
                    }
                  }
                  else {
                    sVar2 = (0xeb - uVar4) * 8;
                  }
                }
                else {
                  sVar2 = (0xf7 - uVar4) * 4;
                }
              }
              else {
                sVar2 = (0xff - uVar4) * 2;
              }
              *(ushort *)((int)local_20 + uVar9 * 2) =
                   sVar2 * ((ushort)(0x7f < *(byte *)(uVar9 + (int)puVar3)) * 2 + -1) * 4;
              uVar9 = uVar9 + 1;
            } while (uVar9 < local_c);
          }
        }
        else {
          for (uVar9 = local_c >> 2; uVar9 != 0; uVar9 = uVar9 - 1) {
            *local_20 = *puVar3;
            puVar3 = puVar3 + 1;
            local_20 = local_20 + 1;
          }
          for (uVar9 = local_c & 3; uVar9 != 0; uVar9 = uVar9 - 1) {
            *(undefined1 *)local_20 = *(undefined1 *)puVar3;
            puVar3 = (undefined4 *)((int)puVar3 + 1);
            local_20 = (undefined4 *)((int)local_20 + 1);
          }
          local_20 = (undefined4 *)0x0;
          uVar9 = local_c;
        }
                    /* WARNING: Subroutine does not return */
        System_ShutdownHandler((int)local_20,uVar9);
      }
    }
    Memory_AllocateBlock(iVar5,iVar7);
  }
LAB_004b4d9a:
  Exception_SetMessage((void *)(local_8 ^ unaff_retaddr),in_stack_ffffffa8,in_stack_ffffffac);
  return;
}


