/*
 * Function: DemoFile_Load
 * Address: 00459610
 * Category: system
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __fastcall DemoFile_Load(int param_1,undefined2 param_2,_String_base *param_3)

{
  char cVar1;
  _String_base _Var2;
  int iVar3;
  _String_base *p_Var4;
  char *pcVar5;
  uint uVar6;
  undefined4 uVar7;
  char *pcVar8;
  char extraout_CL;
  char extraout_CL_00;
  undefined4 extraout_ECX;
  undefined4 extraout_ECX_00;
  undefined4 extraout_ECX_01;
  undefined4 extraout_ECX_02;
  int extraout_ECX_03;
  int extraout_ECX_04;
  int extraout_ECX_05;
  undefined4 extraout_ECX_06;
  undefined4 extraout_ECX_07;
  int extraout_ECX_08;
  undefined2 extraout_DX;
  undefined2 extraout_DX_00;
  undefined2 extraout_DX_01;
  undefined2 extraout_DX_02;
  undefined2 extraout_DX_03;
  undefined2 extraout_DX_04;
  uint extraout_EDX;
  uint extraout_EDX_00;
  undefined4 extraout_EDX_01;
  uint extraout_EDX_02;
  uint extraout_EDX_03;
  uint extraout_EDX_04;
  undefined4 extraout_EDX_05;
  int extraout_EDX_06;
  uint extraout_EDX_07;
  uint extraout_EDX_08;
  uint extraout_EDX_09;
  int extraout_EDX_10;
  int extraout_EDX_11;
  uint extraout_EDX_12;
  undefined8 uVar9;
  uint unaff_retaddr;
  undefined4 *in_stack_00016720;
  undefined4 *in_stack_00016724;
  _String_base local_194 [256];
  _String_base local_94 [4];
  int local_90;
  uint local_7c;
  undefined4 local_78;
  undefined1 local_74 [4];
  uint local_70;
  undefined4 local_60;
  uint local_5c;
  _String_base local_58 [4];
  _String_base local_54 [4];
  uint local_50;
  undefined4 local_44;
  undefined4 local_40;
  uint local_3c;
  uint local_38;
  int local_34;
  int local_30;
  uint local_2c;
  void *local_28;
  uint local_24;
  uint local_20;
  uint local_1c;
  undefined1 local_18 [4];
  uint local_14;
  void *local_10;
  undefined4 uStack_c;
  int local_8;
  
  local_8 = 0xffffffff;
  uStack_c = 0x513696;
  local_10 = ExceptionList;
  local_14 = DAT_00569f5c ^ unaff_retaddr;
  ExceptionList = &local_10;
  iVar3 = String_AllocateBuffer(param_1,param_2);
  if (iVar3 == 0) {
    p_Var4 = Survival_LoadConfiguration
                       (local_54,(_String_base *)"Demo file not found: ",param_1 + 0x4b0);
    local_8 = iVar3;
    PowerUp_ProcessThunderstrike(param_3,extraout_EDX,p_Var4,0,0xffffffff);
    if (0xf < local_3c) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(local_50,extraout_EDX_00);
    }
    goto LAB_00459a85;
  }
  Registry_ReadValue(local_18,iVar3);
  local_8 = 1;
  Memory_GetHeapInfo(extraout_ECX,(short)&local_34);
  if (local_34 == 0x42beef78) {
    Memory_GetHeapInfo(extraout_ECX_00,extraout_DX);
    Memory_GetHeapInfo(extraout_ECX_01,extraout_DX_00);
    Scoring_LoadScores(*(int *)(param_1 + 4));
    local_24 = 4;
    Memory_GetHeapInfo(extraout_ECX_02,(short)&local_24);
    if (0xff < (ushort)local_24) {
      local_24 = 0xff;
    }
    Memory_GetHeapInfo(local_194,extraout_DX_01);
    p_Var4 = local_194;
    local_194[local_24 & 0xffff] = (_String_base)0x0;
    do {
      _Var2 = *p_Var4;
      p_Var4 = p_Var4 + 1;
    } while (_Var2 != (_String_base)0x0);
    uVar6 = String_Compare((void *)(param_1 + 0x354),0,*(uint *)(param_1 + 0x368),local_194,
                           (int)p_Var4 - (int)(local_194 + 1));
    if (uVar6 != 0) {
      iVar3 = Level_InitializeDictastroika(local_94,(char *)local_194);
      local_8._0_1_ = 2;
      p_Var4 = Survival_LoadConfiguration
                         (local_54,(_String_base *)"This demo file appears to be for \'",iVar3);
      local_8._0_1_ = 3;
      p_Var4 = Intel_DisplayPopulationData
                         (local_74,extraout_EDX_02,(_String_base *)local_74,p_Var4,
                          (_String_base *)&DAT_00531760);
      local_8 = CONCAT31(local_8._1_3_,4);
      PowerUp_ProcessThunderstrike(param_3,extraout_EDX_03,p_Var4,0,0xffffffff);
      if (0xf < local_5c) {
                    /* WARNING: Subroutine does not return */
        System_ShutdownHandler(extraout_ECX_04,local_70);
      }
      local_5c = 0xf;
      local_60 = 0;
      local_70 = local_70 & 0xffffff00;
      if (0xf < local_3c) {
                    /* WARNING: Subroutine does not return */
        System_ShutdownHandler(extraout_ECX_04,extraout_EDX_04);
      }
      local_3c = 0xf;
      local_40 = 0;
      local_50 = local_50 & 0xffffff00;
      if (0xf < local_7c) {
                    /* WARNING: Subroutine does not return */
        System_ShutdownHandler(local_90,extraout_EDX_04);
      }
      Registry_WriteValue((int)local_18,extraout_EDX_04);
      goto LAB_00459a85;
    }
    uVar9 = Memory_CompactHeap(extraout_ECX_03,extraout_EDX_01);
    local_20 = (uint)uVar9;
    Memory_DefragmentHeap(extraout_CL,(int)((ulonglong)uVar9 >> 0x20));
    uVar9 = Memory_CompactHeap(extraout_ECX_05,extraout_EDX_05);
    iVar3 = (int)uVar9 - local_20;
    Memory_DefragmentHeap(extraout_CL_00,(int)((ulonglong)uVar9 >> 0x20));
    if (1 < local_38) {
      Memory_GetHeapInfo(extraout_ECX_06,(short)&local_1c);
      local_30 = iVar3 + -4;
      if ((int)local_1c < local_30) {
        ObjectType2_Constructor(&local_78);
        local_8 = CONCAT31(local_8._1_3_,5);
        local_28 = operator_new(local_1c);
        Memory_GetHeapInfo(local_1c,extraout_DX_03);
        BitStream_WriteBuffer(&local_78,(int)local_28,local_1c);
        Level_InitializeFrigistan((int)&local_78);
        local_20 = Array_Initialize((int)&local_78);
        local_2c = 0;
        if (0 < (int)local_20) {
          do {
            uVar7 = Level_InitializeDictastroika((int)&local_78);
            if ((char)uVar7 != '\0') break;
            local_40 = 0xf;
            local_44 = 0;
            local_54[0] = (_String_base)0x0;
            local_3c = 0;
            local_8._0_1_ = 6;
            STL_Iterator_Decrement((void *)(param_1 + 0x520),local_58);
            local_8._0_1_ = 5;
            String_Destructor((int)local_58,extraout_EDX_07);
            iVar3 = *(int *)(*(int *)(param_1 + 0x524) + 4);
            uVar9 = Image_FlipHorizontal(&local_78,local_94);
            local_8._0_1_ = 7;
            PowerUp_ProcessThunderstrike
                      ((_String_base *)(iVar3 + 8),(uint)((ulonglong)uVar9 >> 0x20),
                       (_String_base *)uVar9,0,0xffffffff);
            local_8 = CONCAT31(local_8._1_3_,5);
            String_Destructor((int)local_94,extraout_EDX_08);
            uVar6 = Array_Initialize((int)&local_78);
            *(uint *)(iVar3 + 0x24) = uVar6;
            local_2c = local_2c + 1;
          } while ((int)local_2c < (int)local_20);
        }
        if (local_2c == local_20) {
                    /* WARNING: Subroutine does not return */
          System_ShutdownHandler(local_20,(uint)local_28);
        }
        pcVar5 = "Invalid demo file.";
        do {
          pcVar8 = pcVar5;
          pcVar5 = pcVar8 + 1;
        } while (*pcVar8 != '\0');
        String_Assign(param_3,(_String_base *)"Invalid demo file.",(uint)(pcVar8 + -0x5317f8));
        local_8 = CONCAT31(local_8._1_3_,1);
        Image_ScaleBilinear(&local_78,extraout_EDX_09);
        Registry_WriteValue((int)local_18,extraout_EDX_10);
      }
      else {
        Background_UpdateParallaxLayers(param_3,(_String_base *)"Invalid demo file.");
        Registry_WriteValue((int)local_18,extraout_EDX_06);
      }
      goto LAB_00459a85;
    }
    Memory_GetHeapInfo(extraout_ECX_06,extraout_DX_02);
    uVar6 = iVar3 - 4;
    if (0 < (int)uVar6) {
      local_28 = operator_new(uVar6);
      Memory_GetHeapInfo(extraout_ECX_07,extraout_DX_04);
      BitStream_WriteBuffer((void *)(param_1 + 0x4cc),(int)local_28,uVar6);
      Level_InitializeFrigistan(param_1 + 0x4cc);
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(extraout_ECX_08,extraout_EDX_12);
    }
    pcVar5 = "Invalid demo file.";
    do {
      cVar1 = *pcVar5;
      pcVar5 = pcVar5 + 1;
    } while (cVar1 != '\0');
  }
  else {
    pcVar5 = "Invalid demo file.";
    do {
      cVar1 = *pcVar5;
      pcVar5 = pcVar5 + 1;
    } while (cVar1 != '\0');
  }
  String_Assign(param_3,(_String_base *)"Invalid demo file.",(uint)(pcVar5 + -0x5317f9));
  Registry_WriteValue((int)local_18,extraout_EDX_11);
LAB_00459a85:
  ExceptionList = local_10;
  Exception_SetMessage((void *)(local_14 ^ unaff_retaddr),in_stack_00016720,in_stack_00016724);
  return;
}


