/*
 * Function: CPU_Instruction35
 * Address: 004c8e80
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __fastcall CPU_Instruction35(uint param_1,byte *param_2,uint param_3,int param_4,uint param_5)

{
  uint uVar1;
  int iVar2;
  uint uVar3;
  int iVar4;
  undefined4 *puVar5;
  undefined4 extraout_ECX;
  undefined4 extraout_ECX_00;
  undefined4 extraout_ECX_01;
  undefined4 extraout_ECX_02;
  undefined4 uVar6;
  undefined4 extraout_ECX_03;
  byte *extraout_EDX;
  byte *pbVar7;
  byte *extraout_EDX_00;
  undefined4 extraout_EDX_01;
  undefined2 extraout_var;
  undefined1 *puVar8;
  char *pcVar9;
  int local_8;
  
  uVar3 = param_3;
  uVar1 = *(uint *)(param_3 + 0x68);
  if ((uVar1 & 1) == 0) {
    pcVar9 = "Missing IHDR before PLTE";
  }
  else {
    if ((uVar1 & 4) != 0) {
      CPU_Instruction21(param_1,param_2,param_3,"Invalid PLTE after IDAT");
      CPU_Instruction33(extraout_ECX,extraout_EDX,uVar3,param_5);
      return;
    }
    if ((uVar1 & 2) == 0) goto LAB_004c8ecb;
    pcVar9 = "Duplicate PLTE chunk";
  }
  CPU_Instruction20(param_1,param_2,param_3,pcVar9);
LAB_004c8ecb:
  uVar1 = param_5;
  *(uint *)(uVar3 + 0x68) = *(uint *)(uVar3 + 0x68) | 2;
  pbVar7 = (byte *)(param_5 % 3);
  if (pbVar7 != (byte *)0x0) {
    if (*(char *)(uVar3 + 0x126) != '\x03') {
      CPU_Instruction21(3,pbVar7,uVar3,"Invalid palette chunk");
      CPU_Instruction33(extraout_ECX_00,extraout_EDX_00,uVar3,uVar1);
      return;
    }
    CPU_Instruction20(3,pbVar7,uVar3,"Invalid palette chunk");
  }
  iVar2 = (int)uVar1 / 3;
  puVar5 = PixelFormat_UnpackPixel(uVar3,iVar2,3);
  pbVar7 = (byte *)(*(uint *)(uVar3 + 0x6c) | 0x1000);
  *(byte **)(uVar3 + 0x6c) = pbVar7;
  uVar6 = extraout_ECX_01;
  if (0 < iVar2) {
    puVar8 = (undefined1 *)((int)puVar5 + 2);
    local_8 = iVar2;
    do {
      CPU_Instruction26(&param_3,pbVar7,uVar3,(byte *)&param_3,3);
      pbVar7 = (byte *)CONCAT31((int3)((uint)extraout_EDX_01 >> 8),(undefined1)param_3);
      uVar6 = CONCAT31((int3)((uint)extraout_ECX_02 >> 8),param_3._2_1_);
      puVar8[-1] = param_3._1_1_;
      puVar8[-2] = (undefined1)param_3;
      *puVar8 = param_3._2_1_;
      puVar8 = puVar8 + 3;
      local_8 = local_8 + -1;
    } while (local_8 != 0);
  }
  CPU_Instruction33(uVar6,pbVar7,uVar3,0);
  iVar4 = param_4;
  *(undefined4 **)(uVar3 + 0x114) = puVar5;
  *(short *)(uVar3 + 0x118) = (short)iVar2;
  PNG_SetPhysicalPixelDimensions(uVar3,param_4,puVar5,(short)iVar2);
  if ((((*(char *)(uVar3 + 0x126) == '\x03') && (iVar4 != 0)) &&
      ((*(byte *)(iVar4 + 8) & 0x10) != 0)) &&
     (*(ushort *)(uVar3 + 0x118) < *(ushort *)(uVar3 + 0x11a))) {
    CPU_Instruction21(extraout_ECX_03,(byte *)CONCAT22(extraout_var,*(ushort *)(uVar3 + 0x11a)),
                      uVar3,"Truncating incorrect tRNS chunk length");
    *(undefined2 *)(uVar3 + 0x11a) = *(undefined2 *)(uVar3 + 0x118);
  }
  return;
}


