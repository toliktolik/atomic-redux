/*
 * Function: TextureManager_CreateAtlas
 * Address: 004bb4e0
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __cdecl TextureManager_CreateAtlas(void *param_1,int *param_2,uint param_3,int param_4)

{
  uint extraout_EDX;
  uint uVar1;
  uint extraout_EDX_00;
  uint extraout_EDX_01;
  int iVar2;
  uint uVar3;
  uint unaff_retaddr;
  undefined4 *in_stack_ffffff58;
  undefined4 *in_stack_ffffff5c;
  byte local_50 [16];
  undefined4 local_40;
  undefined4 local_3c [5];
  undefined4 local_28 [5];
  uint local_14;
  void *local_10;
  undefined4 uStack_c;
  int local_8;
  
  local_8 = 0xffffffff;
  uStack_c = 0x517328;
  local_10 = ExceptionList;
  local_14 = DAT_00569f5c ^ unaff_retaddr;
  local_40 = 0;
  ExceptionList = &local_10;
  Texture_Clone((undefined4 *)&stack0xffffff58);
  TextureManager_FlushCache((int *)&stack0xffffff58,param_2,param_3);
  TextureManager_GetCacheSize((int *)local_50,(int *)&stack0xffffff58);
  Texture_CopyToBuffer(local_28);
  local_8 = 0;
  iVar2 = 0;
  do {
    TextureManager_SetCacheLimit(local_28,8);
    TextureManager_Initialize(local_3c,(uint)local_50[iVar2]);
    local_8._0_1_ = 1;
    TextureManager_PreloadTextures(local_28,local_3c);
    local_8 = (uint)local_8._1_3_ << 8;
    Texture_Constructor(local_3c,extraout_EDX);
    iVar2 = iVar2 + 1;
  } while (iVar2 < 0x10);
  iVar2 = ((int)(param_4 + 3 + (param_4 + 3 >> 0x1f & 3U)) >> 2) + -0x20;
  uVar3 = 0;
  if (0 < iVar2) {
    do {
      TextureManager_SetCacheLimit(local_28,4);
      uVar1 = uVar3 & 0x8000000f;
      if ((int)uVar1 < 0) {
        uVar1 = (uVar1 - 1 | 0xfffffff0) + 1;
      }
      TextureManager_Initialize(local_3c,uVar1);
      local_8._0_1_ = 2;
      TextureManager_PreloadTextures(local_28,local_3c);
      local_8 = (uint)local_8._1_3_ << 8;
      Texture_Constructor(local_3c,extraout_EDX_00);
      uVar3 = uVar3 + 1;
    } while ((int)uVar3 < iVar2);
  }
  iVar2 = TextureManager_LoadTexture((int)local_28);
  Texture_GetSize(local_28,iVar2 - param_4);
  TextureManager_Shutdown(param_1,(int)local_28);
  Texture_Constructor(local_28,extraout_EDX_01);
  ExceptionList = local_10;
  Exception_SetMessage((void *)(local_14 ^ unaff_retaddr),in_stack_ffffff58,in_stack_ffffff5c);
  return;
}


