/*
 * Function: Image_ConvertFormat
 * Address: 0049b100
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __fastcall Image_ConvertFormat(undefined4 param_1,uint param_2,_String_base *param_3)

{
  HANDLE hFindFile;
  char cVar1;
  _String_base *p_Var2;
  LPCSTR ***lpFileName;
  BOOL BVar3;
  undefined4 ****extraout_ECX;
  undefined4 ****ppppuVar4;
  int extraout_ECX_00;
  int iVar5;
  undefined4 extraout_ECX_01;
  int extraout_ECX_02;
  int extraout_ECX_03;
  uint extraout_EDX;
  uint extraout_EDX_00;
  uint extraout_EDX_01;
  uint extraout_EDX_02;
  char *pcVar6;
  char *pcVar7;
  bool bVar8;
  undefined8 uVar9;
  uint unaff_retaddr;
  undefined4 *in_stack_fffffe50;
  undefined4 *in_stack_fffffe54;
  char local_184 [276];
  _String_base local_70 [4];
  uint local_6c;
  undefined4 local_5c;
  uint local_58;
  undefined1 local_54 [4];
  LPCSTR **local_50 [4];
  undefined4 local_40;
  uint local_3c;
  HANDLE local_38;
  _String_base local_34 [4];
  undefined4 ***local_30 [4];
  uint local_20;
  uint local_1c;
  undefined1 local_15;
  uint local_14;
  void *local_10;
  undefined *puStack_c;
  int local_8;
  
  local_8 = 0xffffffff;
  puStack_c = &DAT_00515600;
  local_10 = ExceptionList;
  local_14 = DAT_00569f5c ^ unaff_retaddr;
  local_15 = 1;
  local_1c = 0xf;
  local_20 = 0;
  local_30[0] = (undefined4 ***)((uint)local_30[0] & 0xffffff00);
  ExceptionList = &local_10;
  PowerUp_ProcessThunderstrike(local_34,param_2,param_3,0,0xffffffff);
  local_8 = 0;
  if (local_20 < 2) {
    if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler((int)local_30[0],extraout_EDX);
    }
    goto LAB_0049b36c;
  }
  ppppuVar4 = (undefined4 ****)local_30[0];
  if (local_1c < 0x10) {
    ppppuVar4 = local_30;
  }
  if (*(char *)((int)ppppuVar4 + (local_20 - 1)) == '\\') {
    ppppuVar4 = (undefined4 ****)local_30[0];
    if (local_1c < 0x10) {
      ppppuVar4 = local_30;
    }
    if (*(char *)((int)ppppuVar4 + (local_20 - 1)) != '/') goto LAB_0049b19c;
  }
  else {
LAB_0049b19c:
    pcVar6 = "\\";
    do {
      pcVar7 = pcVar6;
      pcVar6 = pcVar7 + 1;
    } while (*pcVar7 != '\0');
    Enemy_ProcessSatelliteLogic(local_34,(_String_base *)&DAT_0053162c,(uint)(pcVar7 + -0x53162c));
    ppppuVar4 = extraout_ECX;
  }
  p_Var2 = Intel_DisplayPopulationData
                     (ppppuVar4,(uint)local_34,local_70,local_34,(_String_base *)&DAT_005343e4);
  if (*(uint *)(p_Var2 + 0x18) < 0x10) {
    p_Var2 = p_Var2 + 4;
  }
  else {
    p_Var2 = *(_String_base **)(p_Var2 + 4);
  }
  local_38 = FindFirstFileA((LPCSTR)p_Var2,(LPWIN32_FIND_DATAA)&stack0xfffffe50);
  if (0xf < local_58) {
                    /* WARNING: Subroutine does not return */
    System_ShutdownHandler(extraout_ECX_00,local_6c);
  }
  if (local_38 == (HANDLE)0xffffffff) {
    if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(extraout_ECX_00,extraout_EDX_00);
    }
  }
  else {
    do {
      if (((uint)in_stack_fffffe50 & 0x10) == 0) {
        Intel_DisplayPopulationData
                  (local_54,(uint)local_184,(_String_base *)local_54,local_34,
                   (_String_base *)local_184);
        lpFileName = (LPCSTR ***)local_50[0];
        if (local_3c < 0x10) {
          lpFileName = local_50;
        }
        BVar3 = DeleteFileA((LPCSTR)lpFileName);
        if (BVar3 == 0) {
          local_15 = 0;
        }
        if (0xf < local_3c) {
                    /* WARNING: Subroutine does not return */
          System_ShutdownHandler(extraout_ECX_02,(uint)local_50[0]);
        }
        local_3c = 0xf;
        local_40 = 0;
        local_50[0] = (LPCSTR **)((uint)local_50[0] & 0xffffff00);
      }
      else {
        iVar5 = 2;
        bVar8 = true;
        pcVar6 = local_184;
        pcVar7 = ".";
        do {
          if (iVar5 == 0) break;
          iVar5 = iVar5 + -1;
          bVar8 = *pcVar6 == *pcVar7;
          pcVar6 = pcVar6 + 1;
          pcVar7 = pcVar7 + 1;
        } while (bVar8);
        if (!bVar8) {
          iVar5 = 3;
          bVar8 = true;
          pcVar6 = local_184;
          pcVar7 = "..";
          do {
            if (iVar5 == 0) break;
            iVar5 = iVar5 + -1;
            bVar8 = *pcVar6 == *pcVar7;
            pcVar6 = pcVar6 + 1;
            pcVar7 = pcVar7 + 1;
          } while (bVar8);
          if (!bVar8) {
            p_Var2 = Intel_DisplayPopulationData
                               (local_184,(uint)local_34,local_70,local_34,(_String_base *)local_184
                               );
            local_8._0_1_ = 1;
            cVar1 = Image_ConvertFormat(extraout_ECX_01,extraout_EDX_01,p_Var2);
            local_8 = (uint)local_8._1_3_ << 8;
            if (0xf < local_58) {
                    /* WARNING: Subroutine does not return */
              System_ShutdownHandler(local_6c,extraout_EDX_02);
            }
            local_58 = 0xf;
            local_5c = 0;
            local_6c = local_6c & 0xffffff00;
            if (cVar1 == '\0') {
              local_15 = 0;
            }
          }
        }
      }
      hFindFile = local_38;
      BVar3 = FindNextFileA(local_38,(LPWIN32_FIND_DATAA)&stack0xfffffe50);
    } while (BVar3 != 0);
    FindClose(hFindFile);
    uVar9 = Debug_GetFlags(extraout_ECX_03);
    if ((int)uVar9 == 0) {
      local_15 = 0;
    }
    if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler((int)local_30[0],(uint)((ulonglong)uVar9 >> 0x20));
    }
  }
LAB_0049b36c:
  ExceptionList = local_10;
  Exception_SetMessage((void *)(local_14 ^ unaff_retaddr),in_stack_fffffe50,in_stack_fffffe54);
  return;
}


