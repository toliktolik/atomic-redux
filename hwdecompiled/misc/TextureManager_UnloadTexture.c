/*
 * Function: TextureManager_UnloadTexture
 * Address: 004ba680
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __thiscall TextureManager_UnloadTexture(void *this,void *param_1,void *param_2,void *param_3)

{
  int iVar1;
  ushort *puVar2;
  byte *pbVar3;
  bool bVar4;
  byte bVar5;
  undefined4 uVar6;
  int iVar7;
  int iVar8;
  uint uVar9;
  byte extraout_DL;
  uint uVar10;
  
  Texture_IsValid((int)param_2);
  uVar6 = Texture_SetAsRenderTarget(param_1,(int)this);
  if ((char)uVar6 != '\0') {
    Texture_SaveToFile(param_3,(int)this);
    return;
  }
  iVar7 = TextureManager_LoadTexture((int)param_1);
  iVar8 = TextureManager_LoadTexture((int)this);
  uVar10 = (1 - iVar7) + iVar8;
  Texture_SaveToFile(param_3,(int)this);
  if (*(int *)((int)param_3 + 0x10) == 0) {
    Texture_Initialize(param_3);
  }
  Texture_GetSize(param_3,uVar10);
  do {
    do {
      do {
        uVar10 = uVar10 - 1;
        if ((int)uVar10 < 0) {
          Texture_SetID((int)param_1);
          bVar5 = Texture_SetID((int)this);
          *(byte *)((int)param_2 + 4) = extraout_DL ^ bVar5;
          return;
        }
        iVar8 = 0;
        iVar7 = 0;
        if (0 < *(int *)((int)param_3 + 0xc)) {
          do {
            iVar1 = iVar8 + (uint)*(ushort *)(*(int *)((int)param_3 + 8) + iVar7 * 2) * 2;
            iVar8 = iVar1 >> 0x10;
            *(short *)(*(int *)((int)param_3 + 8) + iVar7 * 2) = (short)iVar1;
            iVar7 = iVar7 + 1;
          } while (iVar7 < *(int *)((int)param_3 + 0xc));
          if (iVar8 != 0) {
            if (*(int *)((int)param_3 + 0xc) == *(int *)((int)param_3 + 0x10)) {
              Texture_Initialize(param_3);
            }
            *(short *)(*(int *)((int)param_3 + 8) + *(int *)((int)param_3 + 0xc) * 2) =
                 (short)((uint)iVar1 >> 0x10);
            *(int *)((int)param_3 + 0xc) = *(int *)((int)param_3 + 0xc) + 1;
          }
        }
        iVar7 = (int)(uVar10 + ((int)uVar10 >> 0x1f & 0xfU)) >> 4;
        uVar9 = uVar10 & 0x8000000f;
        if ((int)uVar9 < 0) {
          uVar9 = (uVar9 - 1 | 0xfffffff0) + 1;
        }
        bVar5 = (byte)uVar9;
        if ((1 << (bVar5 & 0x1f) & (uint)*(ushort *)(*(int *)((int)this + 8) + iVar7 * 2)) != 0) {
          pbVar3 = *(byte **)((int)param_3 + 8);
          if (*(int *)((int)param_3 + 0xc) == 0) {
            *(undefined4 *)((int)param_3 + 0xc) = 1;
            pbVar3[0] = 1;
            pbVar3[1] = 0;
          }
          else {
            *pbVar3 = *pbVar3 | 1;
          }
        }
        bVar4 = Texture_ClearRenderTarget(param_3,(int)param_1);
      } while (!bVar4);
      if (iVar7 < *(int *)((int)param_2 + 0xc)) {
        puVar2 = (ushort *)(*(int *)((int)param_2 + 8) + iVar7 * 2);
        *puVar2 = *puVar2 | (ushort)(1 << (bVar5 & 0x1f));
      }
      else {
        iVar8 = *(int *)((int)param_2 + 0x10);
        while (iVar8 <= iVar7) {
          Texture_Initialize(param_2);
          iVar8 = *(int *)((int)param_2 + 0x10);
        }
        iVar8 = *(int *)((int)param_2 + 0xc);
        while (iVar8 < iVar7) {
          *(undefined2 *)(*(int *)((int)param_2 + 8) + *(int *)((int)param_2 + 0xc) * 2) = 0;
          iVar8 = *(int *)((int)param_2 + 0xc) + 1;
          *(int *)((int)param_2 + 0xc) = iVar8;
        }
        *(short *)(*(int *)((int)param_2 + 8) + *(int *)((int)param_2 + 0xc) * 2) =
             (short)(1 << (bVar5 & 0x1f));
        *(int *)((int)param_2 + 0xc) = *(int *)((int)param_2 + 0xc) + 1;
      }
      uVar9 = 0;
      iVar7 = 0;
      if (0 < *(int *)((int)param_1 + 0xc)) {
        do {
          puVar2 = (ushort *)(*(int *)((int)param_3 + 8) + iVar7 * 2);
          iVar8 = ((uint)*puVar2 - (uint)*(ushort *)(*(int *)((int)param_1 + 8) + iVar7 * 2)) -
                  uVar9;
          bVar4 = iVar8 < 0;
          if (bVar4) {
            iVar8 = iVar8 + 0x10000;
          }
          uVar9 = (uint)bVar4;
          *puVar2 = (ushort)iVar8;
          iVar7 = iVar7 + 1;
        } while (iVar7 < *(int *)((int)param_1 + 0xc));
        while (uVar9 != 0) {
          puVar2 = (ushort *)(*(int *)((int)param_3 + 8) + iVar7 * 2);
          iVar8 = *puVar2 - uVar9;
          bVar4 = iVar8 < 0;
          if (bVar4) {
            iVar8 = iVar8 + 0x10000;
          }
          *puVar2 = (ushort)iVar8;
          uVar9 = (uint)bVar4;
        }
      }
    } while (*(int *)((int)param_3 + 0xc) < 1);
    do {
      if (*(short *)(*(int *)((int)param_3 + 8) + -2 + *(int *)((int)param_3 + 0xc) * 2) != 0)
      break;
      iVar7 = *(int *)((int)param_3 + 0xc) + -1;
      *(int *)((int)param_3 + 0xc) = iVar7;
    } while (0 < iVar7);
  } while( true );
}


