/*
 * Function: CPU_Instruction49
 * Address: 004ca710
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __fastcall CPU_Instruction49(uint param_1,byte *param_2,byte *param_3,int param_4,uint param_5)

{
  byte bVar1;
  int iVar2;
  byte *pbVar3;
  void *this;
  byte *pbVar4;
  int iVar5;
  int *piVar6;
  undefined4 extraout_ECX;
  undefined4 extraout_ECX_00;
  int extraout_ECX_01;
  undefined4 extraout_ECX_02;
  uint uVar7;
  int extraout_ECX_03;
  int extraout_ECX_04;
  byte *extraout_EDX;
  byte *extraout_EDX_00;
  byte *extraout_EDX_01;
  byte *extraout_EDX_02;
  uint extraout_EDX_03;
  byte *extraout_EDX_04;
  uint extraout_EDX_05;
  byte *pbVar8;
  byte *pbVar9;
  byte *pbVar10;
  uint uVar11;
  byte *pbVar12;
  char *pcVar13;
  undefined4 *in_stack_ffffffac;
  undefined4 *in_stack_ffffffb0;
  int local_18;
  uint local_10;
  
  pbVar3 = param_3;
  this = DAT_00569f5c;
  local_18 = -1;
  if ((param_3[0x68] & 1) == 0) {
    CPU_Instruction20(param_1,param_2,(int)param_3,"Missing IHDR before zTXt");
  }
  if ((*(uint *)(param_3 + 0x68) & 4) != 0) {
    *(uint *)(param_3 + 0x68) = *(uint *)(param_3 + 0x68) | 8;
  }
  pbVar4 = (byte *)CPU_Instruction12((int)param_3,param_5 + 1);
  CPU_Instruction26(extraout_ECX,extraout_EDX,(uint)param_3,pbVar4,param_5);
  iVar5 = CPU_Instruction33(extraout_ECX_00,extraout_EDX_00,(uint)param_3,0);
  if (iVar5 != 0) {
    CPU_Instruction13(extraout_ECX_01,(uint)extraout_EDX_01,(int)param_3,(int)pbVar4);
    Exception_SetMessage(this,in_stack_ffffffac,in_stack_ffffffb0);
    return;
  }
  pbVar4[param_5] = 0;
  bVar1 = *pbVar4;
  pbVar9 = pbVar4;
  iVar5 = extraout_ECX_01;
  while (bVar1 != 0) {
    bVar1 = pbVar9[1];
    iVar5 = CONCAT31((int3)((uint)iVar5 >> 8),bVar1);
    pbVar9 = pbVar9 + 1;
  }
  if (pbVar9 == pbVar4 + param_5) {
    CPU_Instruction21(iVar5,extraout_EDX_01,(uint)param_3,"Zero length zTXt chunk");
    pbVar10 = pbVar9;
  }
  else {
    local_18 = (int)(char)pbVar9[1];
    pbVar10 = pbVar9 + 1;
    if (local_18 == 0) {
      pbVar9 = pbVar9 + 2;
      *(byte **)(param_3 + 0x78) = pbVar4 + (param_5 - (int)pbVar9);
      *(undefined4 *)(param_3 + 0x80) = *(undefined4 *)(param_3 + 0xac);
      iVar5 = *(int *)(param_3 + 0x78);
      *(byte **)(param_3 + 0x74) = pbVar9;
      uVar11 = (int)pbVar9 - (int)pbVar4;
      *(undefined4 *)(param_3 + 0x84) = *(undefined4 *)(param_3 + 0xb0);
      local_10 = 0;
      param_3 = (byte *)0x0;
      pbVar9 = param_3;
      while( true ) {
        param_3 = pbVar9;
        if (iVar5 == 0) goto LAB_004ca9ff;
        pbVar10 = CPU_Instruction9(pbVar3 + 0x74,1);
        if ((pbVar10 != (byte *)0x0) && (pbVar10 != (byte *)0x1)) break;
        if ((*(int *)(pbVar3 + 0x84) == 0) || (pbVar10 == (byte *)0x1)) {
          iVar5 = *(int *)(pbVar3 + 0xb0) - *(int *)(pbVar3 + 0x84);
          if (pbVar9 == (byte *)0x0) {
            param_3 = (byte *)CPU_Instruction12((int)pbVar3,iVar5 + 1 + uVar11);
            iVar5 = *(int *)(pbVar3 + 0x84);
            iVar2 = *(int *)(pbVar3 + 0xb0);
            pbVar9 = *(byte **)(pbVar3 + 0xac);
            pbVar8 = param_3 + uVar11;
            for (uVar7 = (uint)(iVar2 - iVar5) >> 2; uVar7 != 0; uVar7 = uVar7 - 1) {
              *(undefined4 *)pbVar8 = *(undefined4 *)pbVar9;
              pbVar9 = pbVar9 + 4;
              pbVar8 = pbVar8 + 4;
            }
            for (uVar7 = iVar2 - iVar5 & 3; uVar7 != 0; uVar7 = uVar7 - 1) {
              *pbVar8 = *pbVar9;
              pbVar9 = pbVar9 + 1;
              pbVar8 = pbVar8 + 1;
            }
            pbVar9 = pbVar4;
            pbVar8 = param_3;
            for (uVar7 = uVar11 >> 2; uVar7 != 0; uVar7 = uVar7 - 1) {
              *(undefined4 *)pbVar8 = *(undefined4 *)pbVar9;
              pbVar9 = pbVar9 + 4;
              pbVar8 = pbVar8 + 4;
            }
            for (uVar7 = uVar11 & 3; uVar7 != 0; uVar7 = uVar7 - 1) {
              *pbVar8 = *pbVar9;
              pbVar9 = pbVar9 + 1;
              pbVar8 = pbVar8 + 1;
            }
            local_10 = (*(int *)(pbVar3 + 0xb0) - *(int *)(pbVar3 + 0x84)) + uVar11;
            param_3[local_10] = 0;
          }
          else {
            param_3 = (byte *)CPU_Instruction12((int)pbVar3,iVar5 + 1 + local_10);
            pbVar8 = pbVar9;
            pbVar12 = param_3;
            for (uVar7 = local_10 >> 2; uVar7 != 0; uVar7 = uVar7 - 1) {
              *(undefined4 *)pbVar12 = *(undefined4 *)pbVar8;
              pbVar8 = pbVar8 + 4;
              pbVar12 = pbVar12 + 4;
            }
            for (uVar7 = local_10 & 3; uVar7 != 0; uVar7 = uVar7 - 1) {
              *pbVar12 = *pbVar8;
              pbVar8 = pbVar8 + 1;
              pbVar12 = pbVar12 + 1;
            }
            CPU_Instruction13(0,local_10,(int)pbVar3,(int)pbVar9);
            iVar5 = *(int *)(pbVar3 + 0x84);
            iVar2 = *(int *)(pbVar3 + 0xb0);
            pbVar9 = *(byte **)(pbVar3 + 0xac);
            pbVar8 = param_3 + local_10;
            for (uVar7 = (uint)(iVar2 - iVar5) >> 2; uVar7 != 0; uVar7 = uVar7 - 1) {
              *(undefined4 *)pbVar8 = *(undefined4 *)pbVar9;
              pbVar9 = pbVar9 + 4;
              pbVar8 = pbVar8 + 4;
            }
            for (uVar7 = iVar2 - iVar5 & 3; uVar7 != 0; uVar7 = uVar7 - 1) {
              *pbVar8 = *pbVar9;
              pbVar9 = pbVar9 + 1;
              pbVar8 = pbVar8 + 1;
            }
            local_10 = local_10 + (*(int *)(pbVar3 + 0xb0) - *(int *)(pbVar3 + 0x84));
            param_3[local_10] = 0;
          }
          if (pbVar10 == (byte *)0x1) goto LAB_004ca9ff;
          *(undefined4 *)(pbVar3 + 0x80) = *(undefined4 *)(pbVar3 + 0xac);
          *(undefined4 *)(pbVar3 + 0x84) = *(undefined4 *)(pbVar3 + 0xb0);
        }
        iVar5 = *(int *)(pbVar3 + 0x78);
        pbVar9 = param_3;
      }
      pcVar13 = *(char **)(pbVar3 + 0x8c);
      if (pcVar13 == (char *)0x0) {
        pcVar13 = s_Error_decoding_zTXt_chunk_00568210;
      }
      CPU_Instruction21(extraout_ECX_02,extraout_EDX_02,(uint)pbVar3,pcVar13);
      CPU_Instruction5((int)(pbVar3 + 0x74));
      pbVar3[0x78] = 0;
      pbVar3[0x79] = 0;
      pbVar3[0x7a] = 0;
      pbVar3[0x7b] = 0;
      if (pbVar9 == (byte *)0x0) {
        local_10 = uVar11 + 0x1b;
        param_3 = (byte *)CPU_Instruction12((int)pbVar3,local_10);
        pbVar9 = pbVar4;
        pbVar10 = param_3;
        for (uVar7 = uVar11 >> 2; uVar7 != 0; uVar7 = uVar7 - 1) {
          *(undefined4 *)pbVar10 = *(undefined4 *)pbVar9;
          pbVar9 = pbVar9 + 4;
          pbVar10 = pbVar10 + 4;
        }
        for (uVar7 = uVar11 & 3; uVar7 != 0; uVar7 = uVar7 - 1) {
          *pbVar10 = *pbVar9;
          pbVar9 = pbVar9 + 1;
          pbVar10 = pbVar10 + 1;
        }
      }
      param_3[local_10 - 1] = 0;
      pbVar9 = pbVar4 + param_5 + (-1 - (int)param_3);
      if ((byte *)0x19 < pbVar9) {
        pbVar9 = (byte *)0x1a;
      }
      pbVar10 = (byte *)s_Error_decoding_zTXt_chunk_00568210;
      pbVar8 = param_3 + uVar11;
      for (uVar7 = (uint)(pbVar9 + 1) >> 2; uVar7 != 0; uVar7 = uVar7 - 1) {
        *(undefined4 *)pbVar8 = *(undefined4 *)pbVar10;
        pbVar10 = pbVar10 + 4;
        pbVar8 = pbVar8 + 4;
      }
      for (uVar7 = (uint)(pbVar9 + 1) & 3; uVar7 != 0; uVar7 = uVar7 - 1) {
        *pbVar8 = *pbVar10;
        pbVar10 = pbVar10 + 1;
        pbVar8 = pbVar8 + 1;
      }
LAB_004ca9ff:
      CPU_Instruction5((int)(pbVar3 + 0x74));
      pbVar3[0x78] = 0;
      pbVar3[0x79] = 0;
      pbVar3[0x7a] = 0;
      pbVar3[0x7b] = 0;
      CPU_Instruction13(extraout_ECX_03,extraout_EDX_03,(int)pbVar3,(int)pbVar4);
      pbVar10 = param_3 + uVar11;
      pbVar4 = param_3;
      goto LAB_004caa71;
    }
    Exception_Release(&stack0xffffffac,"Unknown zTXt compression type %d");
    CPU_Instruction21(&stack0xffffffac,extraout_EDX_04,(uint)param_3,&stack0xffffffac);
    pbVar9 = pbVar4 + param_5 + (-1 - (int)pbVar10);
    if ((byte *)0x19 < pbVar9) {
      pbVar9 = (byte *)0x1a;
    }
    pbVar8 = (byte *)s_Error_decoding_zTXt_chunk_00568210;
    pbVar12 = pbVar10;
    for (uVar11 = (uint)(pbVar9 + 1) >> 2; uVar11 != 0; uVar11 = uVar11 - 1) {
      *(undefined4 *)pbVar12 = *(undefined4 *)pbVar8;
      pbVar8 = pbVar8 + 4;
      pbVar12 = pbVar12 + 4;
    }
    for (uVar11 = (uint)(pbVar9 + 1) & 3; uVar11 != 0; uVar11 = uVar11 - 1) {
      *pbVar12 = *pbVar8;
      pbVar8 = pbVar8 + 1;
      pbVar12 = pbVar12 + 1;
    }
  }
LAB_004caa71:
  piVar6 = (int *)CPU_Instruction12((int)pbVar3,0x10);
  *piVar6 = local_18;
  piVar6[1] = (int)pbVar4;
  piVar6[2] = (int)pbVar10;
  PNG_SetPaletteToHistogram((int)pbVar3,param_4,(int)piVar6,1);
  CPU_Instruction13(extraout_ECX_04,extraout_EDX_05,(int)pbVar3,(int)piVar6);
  Exception_SetMessage(this,in_stack_ffffffac,in_stack_ffffffb0);
  return;
}


