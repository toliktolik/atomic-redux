/*
 * Function: PopCap_SaveRegistrationInfo
 * Address: 004b08b0
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


/* WARNING: Type propagation algorithm not settling */

void __fastcall PopCap_SaveRegistrationInfo(void *param_1)

{
  byte bVar1;
  uint uVar2;
  byte *pbVar3;
  int iVar4;
  int iVar5;
  char *pcVar6;
  char extraout_CL;
  char extraout_CL_00;
  undefined4 extraout_ECX;
  uint extraout_ECX_00;
  uint uVar7;
  undefined4 extraout_ECX_01;
  uint extraout_ECX_02;
  int extraout_ECX_03;
  int extraout_ECX_04;
  int extraout_ECX_05;
  int extraout_ECX_06;
  undefined2 uVar8;
  undefined2 extraout_DX;
  int extraout_EDX;
  int iVar9;
  int extraout_EDX_00;
  uint extraout_EDX_01;
  uint extraout_EDX_02;
  uint extraout_EDX_03;
  uint extraout_EDX_04;
  uint extraout_EDX_05;
  char *pcVar11;
  byte *pbVar12;
  bool bVar13;
  undefined8 uVar14;
  undefined6 uVar15;
  uint unaff_retaddr;
  undefined4 *in_stack_fffffdac;
  undefined4 *in_stack_fffffdb0;
  char acStack_155 [13];
  char local_148 [244];
  _String_base local_54 [4];
  uint local_50;
  undefined4 local_40;
  uint local_3c;
  undefined4 local_38;
  _String_base local_34 [4];
  uint local_30;
  undefined4 local_20;
  uint local_1c;
  undefined4 local_18;
  uint local_14;
  void *local_10;
  undefined4 uStack_c;
  undefined4 local_8;
  undefined3 uVar10;
  
  local_8 = 0xffffffff;
  uStack_c = 0x516ad8;
  local_10 = ExceptionList;
  local_14 = DAT_00569f5c ^ unaff_retaddr;
  ExceptionList = &local_10;
  UserSettings_SavePreferences(param_1);
  if (*(char *)((int)param_1 + 0x491) == '\0') {
    GetWindowsDirectoryA((LPSTR)((int)acStack_155 + 1),0x100);
    pcVar11 = (char *)((int)acStack_155 + 1);
    do {
      pcVar6 = pcVar11;
      pcVar11 = pcVar6 + 1;
    } while (*pcVar6 != '\0');
    if (pcVar6[-1] != '\\') {
      pcVar11 = acStack_155;
      do {
        pcVar6 = pcVar11 + 1;
        pcVar11 = pcVar11 + 1;
      } while (*pcVar6 != '\0');
      *(undefined2 *)pcVar11 = DAT_0053162c;
    }
    pcVar11 = acStack_155;
    do {
      pcVar6 = pcVar11;
      pcVar11 = pcVar6 + 1;
    } while (pcVar6[1] != '\0');
    *(undefined4 *)(pcVar6 + 1) = s_popcinfo_dat_00536ba8._0_4_;
    *(undefined4 *)(pcVar6 + 5) = s_popcinfo_dat_00536ba8._4_4_;
    *(undefined4 *)(pcVar6 + 9) = s_popcinfo_dat_00536ba8._8_4_;
    pcVar6[0xd] = s_popcinfo_dat_00536ba8[0xc];
    uVar15 = String_AllocateBuffer
                       (s_popcinfo_dat_00536ba8._8_4_,
                        (short)CONCAT31(SUB43(s_popcinfo_dat_00536ba8._0_4_,1),
                                        s_popcinfo_dat_00536ba8[0xc]));
    uVar8 = (undefined2)((uint6)uVar15 >> 0x20);
    iVar5 = (int)uVar15;
    if (iVar5 == 0) {
      iVar5 = String_AllocateBuffer(extraout_ECX,uVar8);
    }
    else {
      uVar14 = Memory_GetHeapInfo((int)&local_18 + 2,uVar8);
      uVar7 = extraout_ECX_00;
      uVar2 = local_18;
      while (iVar9 = (int)((ulonglong)uVar14 >> 0x20), local_18 = uVar2, (int)uVar14 != 0) {
        local_18._2_2_ = (ushort)(uVar2 >> 0x10);
        if (local_18._2_2_ < 0x100) {
          uVar2 = (uint)local_18._2_2_;
          (&stack0xfffffdac)[uVar2] = 0;
          Memory_GetHeapInfo(uVar7,(short)&stack0xfffffdac);
          if (*(uint *)((int)param_1 + 0x3c) < 0x10) {
            pbVar12 = (byte *)((int)param_1 + 0x28);
          }
          else {
            pbVar12 = *(byte **)((int)param_1 + 0x28);
          }
          pbVar3 = &stack0xfffffdac;
          iVar9 = extraout_EDX;
          do {
            bVar1 = *pbVar3;
            uVar10 = (undefined3)((uint)iVar9 >> 8);
            iVar9 = CONCAT31(uVar10,bVar1);
            uVar7 = (uint)bVar1;
            bVar13 = bVar1 < *pbVar12;
            if (bVar1 != *pbVar12) {
LAB_004b0a14:
              iVar4 = (1 - (uint)bVar13) - (uint)(bVar13 != 0);
              goto LAB_004b0a19;
            }
            if (bVar1 == 0) break;
            bVar1 = pbVar3[1];
            iVar9 = CONCAT31(uVar10,bVar1);
            uVar7 = (uint)bVar1;
            bVar13 = bVar1 < pbVar12[1];
            if (bVar1 != pbVar12[1]) goto LAB_004b0a14;
            pbVar3 = pbVar3 + 2;
            pbVar12 = pbVar12 + 2;
          } while (bVar1 != 0);
          iVar4 = 0;
LAB_004b0a19:
          uVar2 = local_18;
          if (iVar4 == 0) {
            Memory_DefragmentHeap((char)(local_18 >> 0x10),-2 - (local_18 >> 0x10));
            break;
          }
        }
        local_18 = uVar2;
        Memory_DefragmentHeap((char)uVar7,iVar9);
        uVar14 = Memory_GetHeapInfo(extraout_ECX_01,extraout_DX);
        uVar7 = extraout_ECX_02;
        uVar2 = local_18;
      }
    }
    if (iVar5 != 0) {
      local_38 = *(undefined4 *)((int)param_1 + 0x38);
      String_CopyData((char)&local_38);
      String_CopyData(extraout_CL);
      local_18 = (uint)*(ushort *)((int)param_1 + 0x678);
      String_CopyData((char)&local_18);
      local_18 = (uint)*(ushort *)((int)param_1 + 0x67c);
      String_CopyData(extraout_CL_00);
      Memory_AllocateBlock(extraout_ECX_03,extraout_EDX_00);
    }
  }
  local_1c = 0xf;
  local_20 = 0;
  local_30 = local_30 & 0xffffff00;
  pcVar11 = "LastVerCheckQueryTime";
  do {
    pcVar6 = pcVar11;
    pcVar11 = pcVar6 + 1;
  } while (*pcVar6 != '\0');
  String_Assign(local_34,(_String_base *)"LastVerCheckQueryTime",(uint)(pcVar6 + -0x536b0c));
  local_8 = 0;
  STL_Vector_Resize(param_1,local_34);
  local_8 = 0xffffffff;
  if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
    System_ShutdownHandler(extraout_ECX_04,extraout_EDX_01);
  }
  local_1c = 0xf;
  local_20 = 0;
  local_30 = local_30 & 0xffffff00;
  pcVar11 = "TimesPlayed";
  do {
    pcVar6 = pcVar11;
    pcVar11 = pcVar6 + 1;
  } while (*pcVar6 != '\0');
  String_Assign(local_34,(_String_base *)"TimesPlayed",(uint)(pcVar6 + -0x536b34));
  local_8 = 1;
  STL_Vector_Resize(param_1,local_34);
  local_8 = 0xffffffff;
  if (local_1c < 0x10) {
    local_1c = 0xf;
    local_20 = 0;
    local_30 = local_30 & 0xffffff00;
    pcVar11 = "TimesExecuted";
    do {
      pcVar6 = pcVar11;
      pcVar11 = pcVar6 + 1;
    } while (*pcVar6 != '\0');
    String_Assign(local_34,(_String_base *)"TimesExecuted",(uint)(pcVar6 + -0x536b24));
    local_8 = 2;
    STL_Vector_Resize(param_1,local_34);
    local_8 = 0xffffffff;
    if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(extraout_ECX_06,extraout_EDX_03);
    }
    bVar13 = *(int *)((int)param_1 + 0x650) == 0;
    if (bVar13) {
      if ((*(int *)((int)param_1 + 0x634) != 0) && (*(int *)((int)param_1 + 0x66c) != 0)) {
        PowerUp_ProcessThunderstrike
                  ((_String_base *)((int)param_1 + 0x63c),extraout_EDX_03,
                   (_String_base *)((int)param_1 + 0x620),0,0xffffffff);
      }
      bVar13 = *(int *)((int)param_1 + 0x650) == 0;
    }
    if (!bVar13) {
      local_1c = 0xf;
      local_20 = 0;
      local_30 = local_30 & 0xffffff00;
      pcVar11 = "RegName";
      do {
        pcVar6 = pcVar11;
        pcVar11 = pcVar6 + 1;
      } while (*pcVar6 != '\0');
      String_Assign(local_34,(_String_base *)"RegName",(uint)(pcVar6 + -0x536b04));
      local_8 = 3;
      STL_Vector_Reserve(param_1,local_34,(int)param_1 + 0x63c);
      local_8 = 0xffffffff;
      if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
        System_ShutdownHandler(local_30,extraout_EDX_04);
      }
    }
    if (*(int *)((int)param_1 + 0x66c) != 0) {
      local_3c = 0xf;
      local_40 = 0;
      local_50 = local_50 & 0xffffff00;
      pcVar11 = "RegCode";
      do {
        pcVar6 = pcVar11;
        pcVar11 = pcVar6 + 1;
      } while (*pcVar6 != '\0');
      String_Assign(local_54,(_String_base *)"RegCode",(uint)(pcVar6 + -0x536afc));
      local_8 = 4;
      STL_Vector_Reserve(param_1,local_54,(int)param_1 + 0x658);
      if (0xf < local_3c) {
                    /* WARNING: Subroutine does not return */
        System_ShutdownHandler(local_50,extraout_EDX_05);
      }
    }
    ExceptionList = local_10;
    Exception_SetMessage((void *)(local_14 ^ unaff_retaddr),in_stack_fffffdac,in_stack_fffffdb0);
    return;
  }
                    /* WARNING: Subroutine does not return */
  System_ShutdownHandler(extraout_ECX_05,extraout_EDX_02);
}


