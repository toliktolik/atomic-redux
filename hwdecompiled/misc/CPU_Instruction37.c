/*
 * Function: CPU_Instruction37
 * Address: 004c9050
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void __fastcall CPU_Instruction37(uint param_1,byte *param_2,uint param_3,int param_4,uint param_5)

{
  uint uVar1;
  float fVar2;
  uint uVar3;
  int iVar4;
  int iVar5;
  uint extraout_ECX;
  undefined4 extraout_ECX_00;
  undefined4 extraout_ECX_01;
  uint extraout_ECX_02;
  undefined4 extraout_ECX_03;
  undefined4 extraout_ECX_04;
  uint extraout_ECX_05;
  byte *extraout_EDX;
  byte *extraout_EDX_00;
  byte *extraout_EDX_01;
  byte *extraout_EDX_02;
  byte *extraout_EDX_03;
  byte *extraout_EDX_04;
  byte *extraout_EDX_05;
  byte *extraout_EDX_06;
  
  iVar4 = param_4;
  uVar3 = param_3;
  uVar1 = *(uint *)(param_3 + 0x68);
  if ((uVar1 & 1) == 0) {
    CPU_Instruction20(param_1,param_2,param_3,"Missing IHDR before gAMA");
    param_1 = extraout_ECX;
    param_2 = extraout_EDX;
  }
  else {
    if ((uVar1 & 4) != 0) {
      CPU_Instruction21(param_1,param_2,param_3,"Invalid gAMA after IDAT");
      CPU_Instruction33(extraout_ECX_01,extraout_EDX_01,uVar3,param_5);
      return;
    }
    if ((uVar1 & 2) == 0) {
      if (((param_4 != 0) && ((*(uint *)(param_4 + 8) & 1) != 0)) &&
         ((*(uint *)(param_4 + 8) & 0x800) == 0)) {
        CPU_Instruction21(param_1,param_2,param_3,"Duplicate gAMA chunk");
        CPU_Instruction33(param_5,extraout_EDX_03,uVar3,param_5);
        return;
      }
    }
    else {
      CPU_Instruction21(param_1,param_2,param_3,"Out of place gAMA chunk");
      param_1 = extraout_ECX_02;
      param_2 = extraout_EDX_02;
    }
  }
  uVar1 = param_5;
  if (param_5 != 4) {
    CPU_Instruction21(param_1,param_2,uVar3,"Incorrect gAMA chunk length");
    CPU_Instruction33(extraout_ECX_00,extraout_EDX_00,uVar3,uVar1);
    return;
  }
  CPU_Instruction26(param_1,(byte *)&param_3,uVar3,(byte *)&param_3,4);
  iVar5 = CPU_Instruction33(extraout_ECX_03,extraout_EDX_04,uVar3,0);
  if ((iVar5 == 0) && (iVar5 = CPU_Instruction24((undefined1 *)&param_3), iVar5 != 0)) {
    if ((*(uint *)(iVar4 + 8) & 0x800) != 0) {
      fVar2 = (float)iVar5;
      if (iVar5 < 0) {
        fVar2 = fVar2 + _DAT_00532f34;
      }
      if ((float)_DAT_00530f20 < ABS(fVar2 - (float)_DAT_00539a28)) {
        CPU_Instruction21(extraout_ECX_04,extraout_EDX_05,uVar3,
                          "Ignoring incorrect gAMA value when sRGB is also present");
        String_ReallocateBuffer(extraout_ECX_05,extraout_EDX_06);
        return;
      }
    }
    fVar2 = (float)iVar5;
    if (iVar5 < 0) {
      fVar2 = fVar2 + _DAT_00532f34;
    }
    fVar2 = fVar2 * _DAT_005399d8;
    *(float *)(uVar3 + 0x15c) = fVar2;
    PNG_SetGamma(uVar3,iVar4,(double)fVar2);
  }
  return;
}


