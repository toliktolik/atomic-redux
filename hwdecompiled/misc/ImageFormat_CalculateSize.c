/*
 * Function: ImageFormat_CalculateSize
 * Address: 004bd3e0
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __fastcall
ImageFormat_CalculateSize(byte *param_1,byte *param_2,uint *param_3,byte *param_4,byte *param_5)

{
  uint *puVar1;
  uint *puVar2;
  uint uVar3;
  byte *pbVar4;
  char *pcVar5;
  byte *extraout_ECX;
  byte *extraout_ECX_00;
  byte *extraout_ECX_01;
  undefined4 extraout_ECX_02;
  byte *extraout_ECX_03;
  byte *extraout_ECX_04;
  byte *extraout_ECX_05;
  void *extraout_ECX_06;
  void *extraout_ECX_07;
  void *extraout_ECX_08;
  void *extraout_ECX_09;
  void *this;
  void *extraout_ECX_10;
  void *extraout_ECX_11;
  byte *extraout_EDX;
  byte *extraout_EDX_00;
  byte *extraout_EDX_01;
  byte *extraout_EDX_02;
  byte *extraout_EDX_03;
  byte *extraout_EDX_04;
  byte *pbVar6;
  
  puVar2 = param_3;
  if ((param_3[0x1b] & 0x40) == 0) {
    CPU_Instruction32(param_3);
    param_1 = extraout_ECX;
    param_2 = extraout_EDX;
  }
  if ((*(char *)((int)puVar2 + 0x123) != '\0') && ((puVar2[0x1c] & 2) != 0)) {
    pbVar6 = param_5;
    switch((char)puVar2[0x49]) {
    case '\0':
      uVar3 = DAT_00567df0;
      if ((puVar2[0x39] & 7) != 0) {
joined_r0x004bd514:
        if (pbVar6 != (byte *)0x0) {
          CPU_Instruction29((int)puVar2,param_5,uVar3);
          param_1 = extraout_ECX_00;
        }
LAB_004bd44a:
        CPU_Instruction51(param_1,(uint)puVar2);
        return;
      }
      break;
    case '\x01':
      uVar3 = DAT_00567df4;
      if (((puVar2[0x39] & 7) != 0) || (puVar2[0x32] < 5)) goto joined_r0x004bd514;
      break;
    case '\x02':
      param_1 = (byte *)(puVar2[0x39] & 0xffffff07);
      if ((char)param_1 != '\x04') {
        param_1 = param_5;
        if (param_5 == (byte *)0x0) goto LAB_004bd44a;
        uVar3 = DAT_00567df8;
        pbVar6 = (byte *)(puVar2[0x39] & 4);
        goto joined_r0x004bd514;
      }
      break;
    case '\x03':
      param_1 = (byte *)CONCAT31((int3)((uint)param_1 >> 8),(byte)puVar2[0x39]);
      uVar3 = DAT_00567dfc;
      if ((((byte)puVar2[0x39] & 3) != 0) || (puVar2[0x32] < 3)) goto joined_r0x004bd514;
      break;
    case '\x04':
      param_2 = (byte *)(puVar2[0x39] & 0xffffff03);
      if ((char)param_2 != '\x02') {
        param_1 = param_5;
        if (param_5 == (byte *)0x0) goto LAB_004bd44a;
        uVar3 = DAT_00567e00;
        pbVar6 = (byte *)(puVar2[0x39] & 2);
        goto joined_r0x004bd514;
      }
      break;
    case '\x05':
      param_1 = param_1;
      uVar3 = DAT_00567e04;
      if (((puVar2[0x39] & 1) != 0) || (param_1 = param_1, puVar2[0x32] < 2))
      goto joined_r0x004bd514;
      break;
    case '\x06':
      if ((puVar2[0x39] & 1) == 0) goto LAB_004bd44a;
    }
  }
  if ((puVar2[0x1a] & 4) == 0) {
    CPU_Instruction20((uint)param_1,param_2,(int)puVar2,"Invalid attempt to read row data");
    param_1 = extraout_ECX_01;
  }
  pbVar6 = (byte *)puVar2[0x3b];
  puVar2[0x20] = (uint)pbVar6;
  puVar2[0x21] = puVar2[0x37];
  do {
    if (puVar2[0x1e] == 0) {
      if (puVar2[0x43] == 0) {
        do {
          CPU_Instruction33(param_1,pbVar6,(uint)puVar2,0);
          CPU_Instruction2(&param_3,extraout_EDX_00,(uint)puVar2,&param_3,4);
          uVar3 = CPU_Instruction24((undefined1 *)&param_3);
          puVar2[0x43] = uVar3;
          PixelFormat_GetGreenComponent((int)puVar2);
          CPU_Instruction26(extraout_ECX_02,extraout_EDX_01,(uint)puVar2,(byte *)(puVar2 + 0x47),4);
          param_1 = (byte *)puVar2[0x47];
          pbVar6 = DAT_00567ce4;
          if (param_1 != DAT_00567ce4) {
            CPU_Instruction20((uint)param_1,DAT_00567ce4,(int)puVar2,"Not enough image data");
            param_1 = extraout_ECX_03;
            pbVar6 = extraout_EDX_02;
          }
        } while (puVar2[0x43] == 0);
      }
      uVar3 = puVar2[0x43];
      pbVar6 = (byte *)puVar2[0x2b];
      puVar2[0x1e] = puVar2[0x2c];
      puVar2[0x1d] = (uint)pbVar6;
      if (uVar3 < puVar2[0x2c]) {
        puVar2[0x1e] = uVar3;
      }
      CPU_Instruction26(uVar3,pbVar6,(uint)puVar2,pbVar6,puVar2[0x1e]);
      puVar2[0x43] = puVar2[0x43] - puVar2[0x1e];
    }
    pbVar4 = CPU_Instruction9((byte *)(puVar2 + 0x1d),1);
    if (pbVar4 == (byte *)0x1) {
      if (((puVar2[0x21] != 0) || (puVar2[0x1e] != 0)) || (puVar2[0x43] != 0)) {
        CPU_Instruction20((uint)extraout_ECX_04,extraout_EDX_03,(int)puVar2,"Extra compressed data")
        ;
      }
      puVar2[0x1a] = puVar2[0x1a] | 8;
      puVar2[0x1b] = puVar2[0x1b] | 0x20;
      break;
    }
    param_1 = extraout_ECX_04;
    pbVar6 = extraout_EDX_03;
    if (pbVar4 != (byte *)0x0) {
      pcVar5 = (char *)puVar2[0x23];
      if (pcVar5 == (char *)0x0) {
        pcVar5 = "Decompression error";
      }
      CPU_Instruction20((uint)extraout_ECX_04,extraout_EDX_03,(int)puVar2,pcVar5);
      param_1 = extraout_ECX_05;
      pbVar6 = extraout_EDX_04;
    }
  } while (puVar2[0x21] != 0);
  *(undefined1 *)((int)puVar2 + 0x10a) = *(undefined1 *)((int)puVar2 + 0x12a);
  *(byte *)((int)puVar2 + 0x10b) = *(byte *)((int)puVar2 + 0x129);
  *(undefined1 *)(puVar2 + 0x42) = *(undefined1 *)((int)puVar2 + 0x126);
  puVar1 = puVar2 + 0x40;
  *puVar1 = puVar2[0x38];
  puVar2[0x41] = (uint)*(byte *)((int)puVar2 + 0x129) * puVar2[0x38] + 7 >> 3;
  *(undefined1 *)((int)puVar2 + 0x109) = *(undefined1 *)((int)puVar2 + 0x127);
  pbVar6 = (byte *)(uint)*(byte *)puVar2[0x3b];
  CPU_Instruction31(puVar2[0x3a] + 1,pbVar6,puVar2,(int)puVar1,(byte *)puVar2[0x3b] + 1,
                    (byte *)(puVar2[0x3a] + 1),pbVar6);
  CPU_Instruction14(puVar2,(undefined4 *)puVar2[0x3a],(undefined4 *)puVar2[0x3b],puVar2[0x36] + 1);
  this = extraout_ECX_06;
  if (puVar2[0x1c] != 0) {
    PixelFormat_ConvertBGRToRGB((uint)puVar2);
    this = extraout_ECX_07;
  }
  if ((*(char *)((int)puVar2 + 0x123) == '\0') ||
     (this = (void *)puVar2[0x1c], ((uint)this & 2) == 0)) {
    if (param_4 != (byte *)0x0) {
      CPU_Instruction29((int)puVar2,param_4,0xff);
      this = extraout_ECX_10;
    }
    if (param_5 == (byte *)0x0) goto LAB_004bd7bf;
    uVar3 = 0xff;
    pbVar6 = param_5;
  }
  else {
    if ((byte)puVar2[0x49] < 6) {
      CPU_Instruction30(puVar1,puVar2[0x3b] + 1,(uint)(byte)puVar2[0x49],(uint)this);
      this = extraout_ECX_08;
    }
    if (param_5 != (byte *)0x0) {
      CPU_Instruction29((int)puVar2,param_5,(&DAT_00567df0)[(byte)puVar2[0x49]]);
      this = extraout_ECX_09;
    }
    if (param_4 == (byte *)0x0) goto LAB_004bd7bf;
    uVar3 = *(uint *)(&DAT_00567dd4 + (uint)(byte)puVar2[0x49] * 4);
    pbVar6 = param_4;
  }
  CPU_Instruction29((int)puVar2,pbVar6,uVar3);
  this = extraout_ECX_11;
LAB_004bd7bf:
  CPU_Instruction51(this,(uint)puVar2);
  if ((code *)puVar2[0x66] != (code *)0x0) {
    (*(code *)puVar2[0x66])(puVar2,puVar2[0x39],(char)puVar2[0x49]);
  }
  return;
}


