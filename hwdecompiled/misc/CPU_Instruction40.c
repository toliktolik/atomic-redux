/*
 * Function: CPU_Instruction40
 * Address: 004c9950
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void __fastcall CPU_Instruction40(uint param_1,byte *param_2,uint param_3,int param_4,uint param_5)

{
  uint uVar1;
  uint uVar2;
  int iVar3;
  int iVar4;
  uint extraout_ECX;
  undefined4 extraout_ECX_00;
  undefined4 extraout_ECX_01;
  uint extraout_ECX_02;
  undefined4 extraout_ECX_03;
  undefined4 extraout_ECX_04;
  uint extraout_ECX_05;
  undefined4 extraout_ECX_06;
  undefined4 uVar5;
  byte *extraout_EDX;
  byte *extraout_EDX_00;
  byte *extraout_EDX_01;
  byte *extraout_EDX_02;
  byte *extraout_EDX_03;
  byte *extraout_EDX_04;
  byte *extraout_EDX_05;
  byte *extraout_EDX_06;
  byte *extraout_EDX_07;
  byte *pbVar6;
  
  iVar3 = param_4;
  uVar2 = param_3;
  uVar1 = *(uint *)(param_3 + 0x68);
  if ((uVar1 & 1) == 0) {
    CPU_Instruction20(param_1,param_2,param_3,"Missing IHDR before sRGB");
    param_1 = extraout_ECX;
    param_2 = extraout_EDX;
  }
  else {
    if ((uVar1 & 4) != 0) {
      CPU_Instruction21(param_1,param_2,param_3,"Invalid sRGB after IDAT");
      CPU_Instruction33(extraout_ECX_01,extraout_EDX_01,uVar2,param_5);
      return;
    }
    if ((uVar1 & 2) == 0) {
      if ((param_4 != 0) && ((*(uint *)(param_4 + 8) & 0x800) != 0)) {
        CPU_Instruction21(param_1,param_2,param_3,"Duplicate sRGB chunk");
        CPU_Instruction33(param_5,extraout_EDX_03,uVar2,param_5);
        return;
      }
    }
    else {
      CPU_Instruction21(param_1,param_2,param_3,"Out of place sRGB chunk");
      param_1 = extraout_ECX_02;
      param_2 = extraout_EDX_02;
    }
  }
  uVar1 = param_5;
  if (param_5 != 1) {
    CPU_Instruction21(param_1,param_2,uVar2,"Incorrect sRGB chunk length");
    CPU_Instruction33(extraout_ECX_00,extraout_EDX_00,uVar2,uVar1);
    return;
  }
  CPU_Instruction26(param_1,(byte *)((int)&param_3 + 3),uVar2,(byte *)((int)&param_3 + 3),1);
  iVar4 = CPU_Instruction33(extraout_ECX_03,extraout_EDX_04,uVar2,0);
  uVar1 = param_3;
  if (iVar4 == 0) {
    if (3 < param_3 >> 0x18) {
      CPU_Instruction21(extraout_ECX_04,extraout_EDX_05,uVar2,"Unknown sRGB intent");
      return;
    }
    uVar5 = extraout_ECX_04;
    pbVar6 = extraout_EDX_05;
    if (((*(byte *)(iVar3 + 8) & 1) != 0) &&
       ((float)_DAT_00530f20 <
        ABS((*(float *)(uVar2 + 0x15c) * _DAT_00539ca4 + (float)_DAT_0052a0e8) -
            (float)_DAT_00539a28))) {
      CPU_Instruction21(extraout_ECX_04,extraout_EDX_05,uVar2,
                        "Ignoring incorrect gAMA value when sRGB is also present");
      String_ReallocateBuffer(extraout_ECX_05,extraout_EDX_06);
      uVar5 = extraout_ECX_06;
      pbVar6 = extraout_EDX_07;
    }
    if (((*(byte *)(iVar3 + 8) & 4) != 0) &&
       ((((((float)_DAT_0052d860 < ABS(*(float *)(iVar3 + 0x80) - _DAT_00539c24) ||
           ((float)_DAT_0052d860 < ABS(*(float *)(iVar3 + 0x84) - _DAT_00539c20))) ||
          ((float)_DAT_0052d860 < ABS(*(float *)(iVar3 + 0x88) - _DAT_00539c1c))) ||
         (((float)_DAT_0052d860 < ABS(*(float *)(iVar3 + 0x8c) - _DAT_00539c18) ||
          ((float)_DAT_0052d860 < ABS(*(float *)(iVar3 + 0x90) - _DAT_00539c14))))) ||
        (((float)_DAT_0052d860 < ABS(*(float *)(iVar3 + 0x94) - _DAT_00539c10) ||
         (((float)_DAT_0052d860 < ABS(*(float *)(iVar3 + 0x98) - _DAT_00539c0c) ||
          ((float)_DAT_0052d860 < ABS(*(float *)(iVar3 + 0x9c) - _DAT_00539c08))))))))) {
      CPU_Instruction21(uVar5,pbVar6,uVar2,"Ignoring incorrect cHRM value when sRGB is also present"
                       );
    }
    PNG_SetStandardPalette(uVar2,iVar3,(char)(uVar1 >> 0x18));
  }
  return;
}


