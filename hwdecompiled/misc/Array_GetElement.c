/*
 * Function: Array_GetElement
 * Address: 004996d0
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


int * __thiscall Array_GetElement(void *this,undefined1 *param_1,int param_2,byte param_3)

{
  byte *pbVar1;
  int iVar2;
  int *piVar3;
  ios_base *this_00;
  uint uVar4;
  int *local_24;
  char local_20;
  void *local_1c;
  undefined4 local_18;
  undefined1 *local_14;
  void *pvStack_10;
  undefined *puStack_c;
  undefined4 local_8;
  
  local_8 = 0xffffffff;
  puStack_c = &DAT_005155a8;
  pvStack_10 = ExceptionList;
  local_14 = &stack0xffffffd0;
  uVar4 = 0;
  local_18 = 0;
  ExceptionList = &pvStack_10;
  *(undefined4 *)((int)this + 4) = 0;
  local_1c = this;
  System_ProcessTaskQueue(&local_24,(int *)this,1);
  if ((local_20 != '\0') && (0 < param_2)) {
                    /* WARNING: Load size is inaccurate */
    piVar3 = *(int **)(*(int *)(*this + 4) + 0x28 + (int)this);
    pbVar1 = *(byte **)piVar3[8];
    local_8 = 1;
    if ((pbVar1 == (byte *)0x0) || (pbVar1 + *(int *)piVar3[0xc] <= pbVar1)) {
      uVar4 = (**(code **)(*piVar3 + 0x10))();
    }
    else {
      uVar4 = (uint)*pbVar1;
    }
    while( true ) {
      if (uVar4 == 0xffffffff) {
        piVar3 = (int *)Array_SetElement();
        return piVar3;
      }
      if (uVar4 == param_3) break;
      param_2 = param_2 + -1;
      if (param_2 < 1) {
        piVar3 = (int *)Array_SetElement();
        return piVar3;
      }
      *(int *)((int)this + 4) = *(int *)((int)this + 4) + 1;
      *param_1 = (char)uVar4;
                    /* WARNING: Load size is inaccurate */
      param_1 = param_1 + 1;
      uVar4 = DirectX_FillSurface(*(int **)(*(int *)(*this + 4) + 0x28 + (int)this));
    }
                    /* WARNING: Load size is inaccurate */
    *(int *)((int)this + 4) = *(int *)((int)this + 4) + 1;
    piVar3 = *(int **)(*(int *)(*this + 4) + 0x28 + (int)this);
    uVar4 = *(uint *)piVar3[8];
    if (uVar4 != 0) {
      iVar2 = *(int *)piVar3[0xc];
      if (uVar4 < iVar2 + uVar4) {
        *(int *)piVar3[0xc] = iVar2 + -1;
        *(int *)piVar3[8] = *(int *)piVar3[8] + 1;
        piVar3 = (int *)Array_SetElement();
        return piVar3;
      }
    }
    (**(code **)(*piVar3 + 0x14))();
    piVar3 = (int *)Array_SetElement();
    return piVar3;
  }
  *param_1 = 0;
  local_8 = 0;
  if (*(int *)((int)this + 4) == 0) {
    uVar4 = 2;
  }
                    /* WARNING: Load size is inaccurate */
  this_00 = (ios_base *)(*(int *)(*this + 4) + (int)this);
  if (uVar4 != 0) {
    uVar4 = uVar4 | *(uint *)(this_00 + 4);
    if (*(int *)(this_00 + 0x28) == 0) {
      uVar4 = uVar4 | 4;
    }
    std::ios_base::clear(this_00,uVar4,false);
  }
  iVar2 = *(int *)(*(int *)(*local_24 + 4) + 0x28 + (int)local_24);
  local_8 = 0xffffffff;
  if (iVar2 != 0) {
    Threading_LeaveCriticalSectionFromPointer((undefined4 *)(iVar2 + 4));
  }
  ExceptionList = pvStack_10;
  return (int *)this;
}


