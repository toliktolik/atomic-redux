/*
 * Function: D3D_LockVertexBuffer
 * Address: 00484dc0
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __thiscall D3D_LockVertexBuffer(void *this,undefined4 param_1,int *param_2)

{
  undefined1 uVar1;
  char *pcVar2;
  char cVar3;
  bool bVar4;
  _String_base *p_Var5;
  LPCSTR ****lpSubKey;
  FARPROC pFVar6;
  int iVar7;
  HDC hdc;
  int iVar8;
  char *pcVar9;
  undefined4 extraout_ECX;
  undefined4 extraout_ECX_00;
  int extraout_ECX_01;
  int extraout_ECX_02;
  int extraout_ECX_03;
  int extraout_ECX_04;
  int extraout_ECX_05;
  undefined2 uVar10;
  undefined2 extraout_DX;
  uint extraout_EDX;
  uint extraout_EDX_00;
  uint extraout_EDX_01;
  uint extraout_EDX_02;
  uint uVar11;
  uint extraout_EDX_03;
  uint extraout_EDX_04;
  uint extraout_EDX_05;
  uint extraout_EDX_06;
  uint extraout_EDX_07;
  uint extraout_EDX_08;
  uint extraout_EDX_09;
  uint extraout_EDX_10;
  uint extraout_EDX_11;
  undefined4 *unaff_ESI;
  int *piVar12;
  undefined4 *puVar13;
  undefined8 uVar14;
  uint unaff_retaddr;
  undefined1 local_5ac [512];
  char local_3ac [536];
  undefined4 local_194;
  undefined4 local_190;
  undefined4 local_18c;
  undefined4 local_188;
  int local_17c [26];
  undefined4 local_114;
  undefined4 local_100 [18];
  undefined4 local_b8;
  undefined4 local_b4;
  undefined4 local_ac;
  undefined4 local_a8;
  undefined4 local_a4;
  undefined4 local_a0;
  undefined4 local_9c;
  undefined4 local_98;
  undefined4 local_94;
  undefined1 local_84 [8];
  _String_base local_7c [4];
  uint local_78;
  uint local_64;
  _String_base local_60 [4];
  LPCSTR ***local_5c [2];
  undefined4 local_54;
  undefined4 local_50;
  undefined4 local_4c;
  uint local_48;
  int local_44;
  int local_40;
  void *local_3c;
  uint local_38;
  _String_base local_34 [4];
  uint local_30;
  undefined4 local_20;
  uint local_1c;
  uint local_18;
  undefined1 *local_14;
  void *pvStack_10;
  undefined *puStack_c;
  undefined4 local_8;
  
  local_8 = 0xffffffff;
  puStack_c = &DAT_00514be0;
  pvStack_10 = ExceptionList;
  local_18 = DAT_00569f5c ^ unaff_retaddr;
  local_14 = &stack0xfffffa48;
  ExceptionList = &pvStack_10;
  local_3c = this;
  System_CleanupInterfaces((int)this);
  if (*(char *)((int)this + 0x80) != '\0') {
    p_Var5 = Survival_LoadConfiguration(local_7c,(_String_base *)"SOFTWARE\\",DAT_0056da10 + 0x5c);
    local_8 = 0;
    p_Var5 = Sound_SetFrequency(extraout_ECX,local_34,local_34,p_Var5);
    local_8 = CONCAT31(local_8._1_3_,1);
    Intel_DisplayPopulationData
              (extraout_ECX_00,extraout_EDX,local_60,p_Var5,(_String_base *)"\\Test3D");
    if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(local_30,extraout_EDX_00);
    }
    local_1c = 0xf;
    local_20 = 0;
    local_30 = local_30 & 0xffffff00;
    if (0xf < local_64) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(extraout_ECX_01,local_78);
    }
    lpSubKey = (LPCSTR ****)local_5c[0];
    if (local_48 < 0x10) {
      lpSubKey = local_5c;
    }
    RegCreateKeyExA((HKEY)0x80000002,(LPCSTR)lpSubKey,0,"",0,0xf003f,(LPSECURITY_ATTRIBUTES)0x0,
                    (PHKEY)((int)this + 0x1c),(LPDWORD)0x0);
    if (0xf < local_48) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(extraout_ECX_02,(uint)local_5c[0]);
    }
  }
  piVar12 = param_2;
  local_8._0_1_ = 2;
  local_8._1_3_ = 0;
  if (param_2 == (int *)0x0) {
    pFVar6 = GetProcAddress(DAT_0056da14,"DirectDrawCreateEx");
    if (pFVar6 != (FARPROC)0x0) {
      iVar7 = (*pFVar6)(0,(int)this + 4,&DAT_00532f10,0);
      D3D_ValidateRenderTarget(iVar7,(_String_base *)"DirectDrawCreateEx");
      goto LAB_00484f3b;
    }
    local_1c = 0xf;
    local_20 = 0;
    local_30 = local_30 & 0xffffff00;
    pcVar2 = "No DirectDrawCreateEx";
    do {
      pcVar9 = pcVar2;
      pcVar2 = pcVar9 + 1;
    } while (*pcVar9 != '\0');
    String_Assign(local_34,(_String_base *)"No DirectDrawCreateEx",(uint)(pcVar9 + -0x5335bc));
    local_8 = CONCAT31(local_8._1_3_,3);
    uVar11 = extraout_EDX_01;
LAB_0048509b:
    D3D_CreateRenderTarget((int)this,uVar11,local_34);
    if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(extraout_ECX_04,local_30);
    }
LAB_004852f7:
    D3D_UnlockVertexBuffer(unaff_ESI);
    return;
  }
  (**(code **)(*param_2 + 4))(param_2);
  *(int **)((int)this + 4) = piVar12;
LAB_00484f3b:
  iVar7 = (**(code **)(**(int **)((int)this + 4) + 0x6c))(*(int **)((int)this + 4),local_5ac,0);
  D3D_ValidateRenderTarget(iVar7,(_String_base *)"GetDeviceIdentifier");
  *(undefined4 *)((int)this + 0x20) = local_194;
  *(undefined4 *)((int)this + 0x24) = local_190;
  *(undefined4 *)((int)this + 0x28) = local_18c;
  *(undefined4 *)((int)this + 0x2c) = local_188;
  local_50 = 0;
  local_4c = 0;
  local_48 = 0;
  local_54 = 0x4000;
  hdc = GetDC((HWND)0x0);
  local_44 = GetDeviceCaps(hdc,8);
  local_40 = GetDeviceCaps(hdc,10);
  iVar7 = GetDeviceCaps(hdc,0xc);
  ReleaseDC((HWND)0x0,hdc);
  iVar8 = (**(code **)(**(int **)((int)this + 4) + 0x5c))
                    (*(int **)((int)this + 4),&local_54,&local_38,local_84);
  if (iVar8 < 0) {
    Image_Clone(local_7c,iVar8);
    local_8._0_1_ = 4;
    uVar14 = Sound_SetPosition(local_34,"GetAvailableVidMem failed: %s");
    local_8._0_1_ = 5;
    D3D_SetRenderTarget((int)this,(uint)((ulonglong)uVar14 >> 0x20),(_String_base *)uVar14);
    if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(extraout_ECX_03,local_30);
    }
    local_1c = 0xf;
    local_20 = 0;
    local_30 = local_30 & 0xffffff00;
    local_8._0_1_ = 2;
    uVar11 = extraout_EDX_02;
    if (0xf < local_64) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(extraout_ECX_03,extraout_EDX_02);
    }
  }
  else {
    uVar11 = iVar7 >> 0x1f & 7;
    local_38 = ((int)(iVar7 + uVar11) >> 3) * local_40 * local_44 + local_38 >> 0x14;
    if (local_38 < *(uint *)((int)this + 0x78)) {
      Level_InitializeDictastroika(local_34,"Not enough video memory.");
      local_8 = CONCAT31(local_8._1_3_,6);
      uVar11 = extraout_EDX_03;
      goto LAB_0048509b;
    }
    if (local_38 < *(uint *)((int)this + 0x7c)) {
      Level_InitializeDictastroika(local_7c,"Low video memory.");
      local_8._0_1_ = 7;
      D3D_SetRenderTarget((int)this,extraout_EDX_04,local_7c);
      local_8._0_1_ = 2;
      String_Destructor((int)local_7c,extraout_EDX_05);
      uVar11 = extraout_EDX_06;
    }
  }
  uVar10 = (undefined2)uVar11;
  if (*(char *)((int)this + 0x80) != '\0') {
    cVar3 = FileIO_DeleteFile(this);
    if (cVar3 != '\0') {
      D3D_UnlockVertexBuffer(unaff_ESI);
      return;
    }
    *(undefined1 *)((int)this + 0x81) = 1;
    uVar10 = extraout_DX;
  }
  bVar4 = D3D_InitializeDevice(this,uVar10,local_3ac);
  if (!bVar4) {
    uVar14 = Sound_SetPosition(local_7c,"Unsupported video card: %s");
    local_8._0_1_ = 8;
    D3D_SetRenderTarget((int)this,(uint)((ulonglong)uVar14 >> 0x20),(_String_base *)uVar14);
    local_8._0_1_ = 2;
    if (0xf < local_64) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(local_78,extraout_EDX_07);
    }
  }
  iVar7 = (**(code **)**(undefined4 **)((int)this + 4))
                    (*(undefined4 **)((int)this + 4),&DAT_00532ee0,(undefined4 *)((int)this + 0x14))
  ;
  D3D_ValidateRenderTarget(iVar7,(_String_base *)"QueryInterface IID_IDirect3D7");
  iVar7 = (**(code **)(**(int **)((int)this + 4) + 0x50))(*(int **)((int)this + 4),param_1,8);
  D3D_ValidateRenderTarget(iVar7,(_String_base *)"SetCooperativeLevel");
  piVar12 = local_17c;
  for (iVar7 = 0x1f; iVar7 != 0; iVar7 = iVar7 + -1) {
    *piVar12 = 0;
    piVar12 = piVar12 + 1;
  }
  local_17c[3] = 100;
  local_17c[2] = 100;
  local_17c[0] = 0x7c;
  local_17c[1] = 7;
  local_114 = 0x2040;
  iVar7 = (**(code **)(**(int **)((int)this + 4) + 0x18))
                    (*(int **)((int)this + 4),local_17c,(undefined4 *)((int)this + 8),0);
  D3D_ValidateRenderTarget(iVar7,(_String_base *)"CreateSurface (Primary)");
  Graphics_BindTextureUnit((int)this + 0x30,extraout_EDX_08,local_17c[3],local_17c[2]);
  piVar12 = *(int **)((int)this + 0x14);
  iVar7 = (**(code **)(*piVar12 + 0x10))
                    (piVar12,&DAT_00532ed0,*(undefined4 *)((int)this + 8),
                     (undefined4 *)((int)this + 0x18));
  D3D_ValidateRenderTarget(iVar7,(_String_base *)"CreateDevice");
  piVar12 = *(int **)((int)this + 0x18);
  param_2 = (int *)0x0;
  iVar7 = (**(code **)(*piVar12 + 0x10))(piVar12,SexyWidget_ProcessUVCallback,&param_2);
  D3D_ValidateRenderTarget(iVar7,(_String_base *)"EnumTextureFormats");
  if (((uint)param_2 & 1) == 0) {
    local_1c = 0xf;
    local_20 = 0;
    local_30 = local_30 & 0xffffff00;
    pcVar2 = "A8R8G8B8 texture format not supported.";
    do {
      pcVar9 = pcVar2;
      pcVar2 = pcVar9 + 1;
    } while (*pcVar9 != '\0');
    String_Assign(local_34,(_String_base *)"A8R8G8B8 texture format not supported.",
                  (uint)(pcVar9 + -0x5334c4));
    local_8._0_1_ = 9;
    D3D_SetRenderTarget((int)this,extraout_EDX_09,local_34);
    local_8._0_1_ = 2;
    uVar1 = (undefined1)local_8;
    local_8._0_1_ = 2;
    if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
      System_ShutdownHandler(extraout_ECX_05,local_30);
    }
    if (((uint)param_2 & 2) == 0) {
      Level_InitializeDictastroika(local_34,"A4R4G4B4 and A8R8G8B8 texture formats not supported.");
      local_8 = CONCAT31(local_8._1_3_,10);
      D3D_CreateRenderTarget((int)this,extraout_EDX_10,local_34);
      if (0xf < local_1c) {
                    /* WARNING: Subroutine does not return */
        System_ShutdownHandler(local_30,extraout_EDX_11);
      }
      goto LAB_004852f7;
    }
    DAT_0056e35a = '\0';
    local_8._0_1_ = uVar1;
  }
  else {
    DAT_0056e35a = '\x01';
  }
  puVar13 = local_100;
  for (iVar7 = 0x1f; iVar7 != 0; iVar7 = iVar7 + -1) {
    *puVar13 = 0;
    puVar13 = puVar13 + 1;
  }
  local_100[3] = 0x40;
  local_100[2] = 0x40;
  local_100[0] = 0x7c;
  local_100[1] = 0x1007;
  local_98 = 0x1000;
  local_94 = 0x10;
  local_b8 = 0x20;
  local_b4 = 0x41;
  if (DAT_0056e35a == '\0') {
    local_ac = 0x10;
    local_9c = 0xf000;
    local_a8 = 0xf00;
    local_a4 = 0xf0;
    local_a0 = 0xf;
  }
  else {
    local_ac = 0x20;
    local_9c = 0xff000000;
    local_a8 = 0xff0000;
    local_a4 = 0xff00;
    local_a0 = 0xff;
  }
  iVar7 = (**(code **)(**(int **)((int)this + 4) + 0x18))
                    (*(int **)((int)this + 4),local_100,(int)this + 0xc,0);
  D3D_ValidateRenderTarget(iVar7,(_String_base *)"CreateSurface (TextureSurface1)");
  puVar13 = local_100;
  iVar7 = (**(code **)(**(int **)((int)this + 4) + 0x18))
                    (*(int **)((int)this + 4),puVar13,(int)this + 0x10,0);
  D3D_ValidateRenderTarget(iVar7,(_String_base *)0x53344c);
  D3D_UnlockVertexBuffer(puVar13);
  return;
}


