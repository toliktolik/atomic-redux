/*
 * Function: ImageDecoder_Finalize
 * Address: 004ce2e0
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __cdecl ImageDecoder_Finalize(byte *param_1,byte *param_2)

{
  undefined1 *puVar1;
  byte bVar2;
  byte *pbVar3;
  byte bVar4;
  uint uVar5;
  byte *pbVar6;
  byte *pbVar7;
  byte *pbVar8;
  int iVar9;
  byte *pbVar10;
  byte *pbVar11;
  char *pcVar12;
  int iVar13;
  int iVar14;
  byte bVar15;
  uint uVar16;
  uint uVar17;
  uint uVar18;
  byte *pbVar19;
  byte *pbVar20;
  byte *pbVar21;
  int iVar22;
  byte *local_30;
  byte *local_2c;
  byte *local_28;
  int local_24;
  byte *local_20;
  byte *local_10;
  
  pbVar3 = param_1;
  bVar2 = param_1[0x125];
  uVar16 = (uint)param_1[0x1f9];
  pbVar7 = *(byte **)(param_2 + 4);
  pbVar8 = *(byte **)(param_1 + 0xec);
  iVar13 = *(int *)(param_1 + 0xe8);
  pbVar20 = (byte *)((int)(param_2[0xb] + 7) >> 3);
  local_10 = (byte *)0x7fffffff;
  if (((bVar2 & 8) != 0) && (bVar2 != 8)) {
    local_10 = (byte *)0x0;
    local_2c = (byte *)0x0;
    if (pbVar7 != (byte *)0x0) {
      do {
        uVar17 = (uint)(pbVar8 + 1)[(int)local_2c];
        if (0x7f < uVar17) {
          uVar17 = 0x100 - uVar17;
        }
        local_10 = local_10 + uVar17;
        local_2c = local_2c + 1;
      } while (local_2c < pbVar7);
    }
    if (param_1[0x1f8] == 2) {
      uVar17 = (uint)local_10 >> 10 & 0x3fffc0;
      uVar18 = (uint)local_10 & 0xffff;
      iVar9 = 0;
      if (uVar16 != 0) {
        do {
          if (*(char *)(*(int *)(param_1 + 0x1fc) + iVar9) == '\0') {
            uVar5 = (uint)*(ushort *)(*(int *)(param_1 + 0x200) + iVar9 * 2);
            uVar18 = uVar5 * uVar18 >> 8;
            uVar17 = uVar5 * uVar17 >> 8;
          }
          iVar9 = iVar9 + 1;
        } while (iVar9 < (int)uVar16);
      }
      uVar17 = **(ushort **)(param_1 + 0x208) * uVar17 >> 3;
      if (uVar17 < 0x3fffc1) {
        local_10 = (byte *)((**(ushort **)(param_1 + 0x208) * uVar18 >> 3) + uVar17 * 0x400);
      }
      else {
        local_10 = (byte *)0x7fffffff;
      }
    }
  }
  if (bVar2 == 0x10) {
    pbVar19 = pbVar8 + 1;
    pbVar6 = (byte *)(*(int *)(param_1 + 0xf0) + 1);
    pbVar11 = (byte *)0x0;
    pbVar10 = pbVar19;
    for (pbVar21 = pbVar20; pbVar21 != (byte *)0x0; pbVar21 = pbVar21 + -1) {
      bVar4 = *pbVar10;
      pbVar10 = pbVar10 + 1;
      *pbVar6 = bVar4;
      pbVar6 = pbVar6 + 1;
      pbVar11 = pbVar20;
    }
    if (pbVar11 < pbVar7) {
      iVar9 = (int)pbVar7 - (int)pbVar11;
      do {
        bVar4 = *pbVar10;
        bVar15 = *pbVar19;
        pbVar10 = pbVar10 + 1;
        pbVar19 = pbVar19 + 1;
        *pbVar6 = bVar4 - bVar15;
        pbVar6 = pbVar6 + 1;
        iVar9 = iVar9 + -1;
      } while (iVar9 != 0);
    }
    local_20 = *(byte **)(param_1 + 0xf0);
LAB_004ce45c:
    if ((bVar2 & 0x20) != 0) {
      pbVar21 = (byte *)0x0;
      local_30 = local_10;
      if (param_1[0x1f8] == 2) {
        uVar18 = (uint)local_10 & 0xffff;
        uVar17 = (uint)local_10 >> 10 & 0x3fffc0;
        iVar9 = 0;
        if (uVar16 != 0) {
          do {
            if (*(char *)(*(int *)(param_1 + 0x1fc) + iVar9) == '\x02') {
              uVar5 = (uint)*(ushort *)(*(int *)(param_1 + 0x204) + iVar9 * 2);
              uVar18 = uVar5 * uVar18 >> 8;
              uVar17 = uVar5 * uVar17 >> 8;
            }
            iVar9 = iVar9 + 1;
          } while (iVar9 < (int)uVar16);
        }
        uVar17 = *(ushort *)(*(int *)(param_1 + 0x20c) + 4) * uVar17 >> 3;
        if (uVar17 < 0x3fffc1) {
          local_30 = (byte *)((*(ushort *)(*(int *)(param_1 + 0x20c) + 4) * uVar18 >> 3) +
                             uVar17 * 0x400);
        }
        else {
          local_30 = (byte *)0x7fffffff;
        }
      }
      pbVar11 = *(byte **)(param_1 + 0xf4);
      pbVar10 = pbVar8 + 1;
      param_1 = (byte *)0x0;
      if (pbVar7 != (byte *)0x0) {
        iVar9 = (iVar13 + 1) - (int)pbVar10;
        do {
          pbVar11 = pbVar11 + 1;
          bVar4 = *pbVar10;
          bVar15 = pbVar10[iVar9];
          *pbVar11 = bVar4 - bVar15;
          uVar17 = (uint)(byte)(bVar4 - bVar15);
          pbVar10 = pbVar10 + 1;
          if (0x7f < uVar17) {
            uVar17 = 0x100 - uVar17;
          }
          pbVar21 = pbVar21 + uVar17;
        } while ((pbVar21 <= local_30) && (param_1 = param_1 + 1, param_1 < pbVar7));
      }
      if (pbVar3[0x1f8] == 2) {
        uVar18 = (uint)pbVar21 & 0xffff;
        uVar17 = (uint)pbVar21 >> 10 & 0x3fffc0;
        iVar9 = 0;
        if (uVar16 != 0) {
          do {
            if (*(char *)(*(int *)(pbVar3 + 0x1fc) + iVar9) == '\x02') {
              uVar5 = (uint)*(ushort *)(*(int *)(pbVar3 + 0x200) + iVar9 * 2);
              uVar18 = uVar5 * uVar18 >> 8;
              uVar17 = uVar5 * uVar17 >> 8;
            }
            iVar9 = iVar9 + 1;
          } while (iVar9 < (int)uVar16);
        }
        uVar17 = *(ushort *)(*(int *)(pbVar3 + 0x208) + 4) * uVar17 >> 3;
        if (uVar17 < 0x3fffc1) {
          pbVar21 = (byte *)((*(ushort *)(*(int *)(pbVar3 + 0x208) + 4) * uVar18 >> 3) +
                            uVar17 * 0x400);
        }
        else {
          pbVar21 = (byte *)0x7fffffff;
        }
      }
      if (pbVar21 < local_10) {
        local_20 = *(byte **)(pbVar3 + 0xf4);
        local_10 = pbVar21;
      }
    }
    if (bVar2 != 0x40) goto LAB_004ce71a;
    pcVar12 = (char *)(*(int *)(pbVar3 + 0xf8) + 1);
    pbVar6 = (byte *)(iVar13 + 1);
    pbVar11 = (byte *)0x0;
    pbVar10 = pbVar8;
    for (pbVar21 = pbVar20; pbVar10 = pbVar10 + 1, pbVar21 != (byte *)0x0; pbVar21 = pbVar21 + -1) {
      *pcVar12 = *pbVar10 - (*pbVar6 >> 1);
      pcVar12 = pcVar12 + 1;
      pbVar6 = pbVar6 + 1;
      pbVar11 = pbVar20;
    }
    if (pbVar11 < pbVar7) {
      param_1 = pbVar7 + -(int)pbVar11;
      param_2 = pbVar8;
      do {
        param_2 = param_2 + 1;
        *pcVar12 = *pbVar10 - (char)(((uint)*pbVar6 + (uint)*param_2) / 2);
        pcVar12 = pcVar12 + 1;
        pbVar6 = pbVar6 + 1;
        pbVar10 = pbVar10 + 1;
        param_1 = param_1 + -1;
      } while (param_1 != (byte *)0x0);
    }
    local_20 = *(byte **)(pbVar3 + 0xf8);
  }
  else {
    local_20 = pbVar8;
    if ((bVar2 & 0x10) != 0) {
      pbVar21 = (byte *)0x0;
      local_2c = local_10;
      if (param_1[0x1f8] == 2) {
        uVar18 = (uint)local_10 & 0xffff;
        uVar17 = (uint)local_10 >> 10 & 0x3fffc0;
        iVar9 = 0;
        if (uVar16 != 0) {
          do {
            if (*(char *)(*(int *)(param_1 + 0x1fc) + iVar9) == '\x01') {
              uVar5 = (uint)*(ushort *)(*(int *)(param_1 + 0x204) + iVar9 * 2);
              uVar18 = uVar5 * uVar18 >> 8;
              uVar17 = uVar5 * uVar17 >> 8;
            }
            iVar9 = iVar9 + 1;
          } while (iVar9 < (int)uVar16);
        }
        uVar17 = *(ushort *)(*(int *)(param_1 + 0x20c) + 2) * uVar17 >> 3;
        if (uVar17 < 0x3fffc1) {
          local_2c = (byte *)((*(ushort *)(*(int *)(param_1 + 0x20c) + 2) * uVar18 >> 3) +
                             uVar17 * 0x400);
        }
        else {
          local_2c = (byte *)0x7fffffff;
        }
      }
      pbVar6 = (byte *)(*(int *)(param_1 + 0xf0) + 1);
      local_28 = (byte *)0x0;
      pbVar10 = pbVar8;
      for (pbVar11 = pbVar20; pbVar10 = pbVar10 + 1, pbVar11 != (byte *)0x0; pbVar11 = pbVar11 + -1)
      {
        uVar17 = (uint)*pbVar10;
        *pbVar6 = *pbVar10;
        if (0x7f < uVar17) {
          uVar17 = 0x100 - uVar17;
        }
        pbVar21 = pbVar21 + uVar17;
        pbVar6 = pbVar6 + 1;
        local_28 = pbVar20;
      }
      local_30 = pbVar8;
      if (local_28 < *(byte **)(param_2 + 4)) {
        do {
          local_30 = local_30 + 1;
          bVar4 = *pbVar10;
          bVar15 = *local_30;
          *pbVar6 = bVar4 - bVar15;
          uVar17 = (uint)(byte)(bVar4 - bVar15);
          if (0x7f < uVar17) {
            uVar17 = 0x100 - uVar17;
          }
          pbVar21 = pbVar21 + uVar17;
          if (local_2c < pbVar21) break;
          local_28 = local_28 + 1;
          pbVar10 = pbVar10 + 1;
          pbVar6 = pbVar6 + 1;
        } while (local_28 < *(byte **)(param_2 + 4));
      }
      if (param_1[0x1f8] == 2) {
        uVar17 = (uint)pbVar21 >> 10 & 0x3fffc0;
        uVar18 = (uint)pbVar21 & 0xffff;
        iVar9 = 0;
        if (uVar16 != 0) {
          do {
            if (*(char *)(*(int *)(param_1 + 0x1fc) + iVar9) == '\x01') {
              uVar5 = (uint)*(ushort *)(*(int *)(param_1 + 0x204) + iVar9 * 2);
              uVar18 = uVar5 * uVar18 >> 8;
              uVar17 = uVar5 * uVar17 >> 8;
            }
            iVar9 = iVar9 + 1;
          } while (iVar9 < (int)uVar16);
        }
        uVar17 = *(ushort *)(*(int *)(param_1 + 0x20c) + 2) * uVar17 >> 3;
        if (uVar17 < 0x3fffc1) {
          pbVar21 = (byte *)((*(ushort *)(*(int *)(param_1 + 0x20c) + 2) * uVar18 >> 3) +
                            uVar17 * 0x400);
        }
        else {
          pbVar21 = (byte *)0x7fffffff;
        }
      }
      if (pbVar21 < local_10) {
        local_20 = *(byte **)(param_1 + 0xf0);
        local_10 = pbVar21;
      }
    }
    if (bVar2 != 0x20) goto LAB_004ce45c;
    pcVar12 = *(char **)(param_1 + 0xf4);
    pbVar21 = (byte *)0x0;
    if (pbVar7 != (byte *)0x0) {
      pbVar11 = pbVar8 + 1 + (iVar13 - (int)pbVar8);
      do {
        pcVar12 = pcVar12 + 1;
        pbVar10 = pbVar21 + (int)(pbVar8 + 1);
        pbVar21 = pbVar21 + 1;
        *pcVar12 = *pbVar10 - *pbVar11;
        pbVar11 = pbVar11 + 1;
      } while (pbVar21 < pbVar7);
    }
    local_20 = *(byte **)(param_1 + 0xf4);
LAB_004ce71a:
    if ((bVar2 & 0x40) != 0) {
      param_2 = (byte *)0x0;
      local_2c = local_10;
      if (pbVar3[0x1f8] == 2) {
        uVar18 = (uint)local_10 & 0xffff;
        uVar17 = (uint)local_10 >> 10 & 0x3fffc0;
        iVar9 = 0;
        if (uVar16 != 0) {
          do {
            if (*(char *)(iVar9 + *(int *)(pbVar3 + 0x1fc)) == '\x03') {
              uVar5 = (uint)*(ushort *)(*(int *)(pbVar3 + 0x204) + iVar9 * 2);
              uVar18 = uVar5 * uVar18 >> 8;
              uVar17 = uVar5 * uVar17 >> 8;
            }
            iVar9 = iVar9 + 1;
          } while (iVar9 < (int)uVar16);
        }
        uVar17 = *(ushort *)(*(int *)(pbVar3 + 0x20c) + 6) * uVar17 >> 3;
        if (uVar17 < 0x3fffc1) {
          local_2c = (byte *)((*(ushort *)(*(int *)(pbVar3 + 0x20c) + 6) * uVar18 >> 3) +
                             uVar17 * 0x400);
        }
        else {
          local_2c = (byte *)0x7fffffff;
        }
      }
      pbVar10 = (byte *)(*(int *)(pbVar3 + 0xf8) + 1);
      pbVar6 = (byte *)(iVar13 + 1);
      param_1 = (byte *)0x0;
      pbVar11 = pbVar8;
      for (pbVar21 = pbVar20; pbVar11 = pbVar11 + 1, local_30 = pbVar8, pbVar21 != (byte *)0x0;
          pbVar21 = pbVar21 + -1) {
        bVar4 = *pbVar11 - (*pbVar6 >> 1);
        *pbVar10 = bVar4;
        pbVar10 = pbVar10 + 1;
        uVar17 = (uint)bVar4;
        pbVar6 = pbVar6 + 1;
        if (0x7f < uVar17) {
          uVar17 = 0x100 - uVar17;
        }
        param_2 = param_2 + uVar17;
        param_1 = pbVar20;
      }
      for (; param_1 < pbVar7; param_1 = param_1 + 1) {
        local_30 = local_30 + 1;
        bVar4 = *pbVar11 - (char)(((uint)*local_30 + (uint)*pbVar6) / 2);
        *pbVar10 = bVar4;
        uVar17 = (uint)bVar4;
        pbVar6 = pbVar6 + 1;
        pbVar11 = pbVar11 + 1;
        if (0x7f < uVar17) {
          uVar17 = 0x100 - uVar17;
        }
        param_2 = param_2 + uVar17;
        if (local_2c < param_2) break;
        pbVar10 = pbVar10 + 1;
      }
      if (pbVar3[0x1f8] == 2) {
        uVar18 = (uint)param_2 & 0xffff;
        uVar17 = (uint)param_2 >> 10 & 0x3fffc0;
        iVar9 = 0;
        if (uVar16 != 0) {
          do {
            if (*(char *)(iVar9 + *(int *)(pbVar3 + 0x1fc)) == '\0') {
              uVar5 = (uint)*(ushort *)(*(int *)(pbVar3 + 0x200) + iVar9 * 2);
              uVar18 = uVar5 * uVar18 >> 8;
              uVar17 = uVar5 * uVar17 >> 8;
            }
            iVar9 = iVar9 + 1;
          } while (iVar9 < (int)uVar16);
        }
        uVar17 = *(ushort *)(*(int *)(pbVar3 + 0x208) + 6) * uVar17 >> 3;
        if (uVar17 < 0x3fffc1) {
          param_2 = (byte *)((*(ushort *)(*(int *)(pbVar3 + 0x208) + 6) * uVar18 >> 3) +
                            uVar17 * 0x400);
        }
        else {
          param_2 = (byte *)0x7fffffff;
        }
      }
      if (param_2 < local_10) {
        local_10 = param_2;
        local_20 = *(byte **)(pbVar3 + 0xf8);
      }
    }
    if (bVar2 == 0x80) {
      pbVar8 = pbVar8 + 1;
      param_1 = (byte *)0x0;
      local_2c = pbVar8;
      local_30 = (byte *)(*(int *)(pbVar3 + 0xfc) + 1);
      pbVar11 = (byte *)(iVar13 + 1);
      for (pbVar21 = pbVar20; pbVar21 != (byte *)0x0; pbVar21 = pbVar21 + -1) {
        *local_30 = *local_2c - *pbVar11;
        pbVar11 = pbVar11 + 1;
        local_2c = local_2c + 1;
        local_30 = (byte *)((char *)local_30 + 1);
        param_1 = pbVar20;
      }
      if (param_1 < pbVar7) {
        iVar13 = (iVar13 + 1) - (int)pbVar8;
        local_28 = (byte *)((int)pbVar7 - (int)param_1);
        do {
          bVar2 = pbVar8[iVar13];
          bVar4 = *pbVar11;
          bVar15 = *pbVar8;
          pbVar11 = pbVar11 + 1;
          pbVar8 = pbVar8 + 1;
          pbVar7 = (byte *)((uint)bVar4 - (uint)bVar2);
          iVar9 = (uint)bVar15 - (uint)bVar2;
          param_1 = pbVar7;
          if ((int)pbVar7 < 0) {
            param_1 = (byte *)-(int)pbVar7;
          }
          iVar14 = iVar9;
          if (iVar9 < 0) {
            iVar14 = -iVar9;
          }
          pbVar7 = pbVar7 + iVar9;
          if ((int)pbVar7 < 0) {
            pbVar7 = (byte *)-(int)pbVar7;
          }
          if (((iVar14 < (int)param_1) || ((int)pbVar7 < (int)param_1)) &&
             (bVar15 = bVar2, iVar14 <= (int)pbVar7)) {
            bVar15 = bVar4;
          }
          *local_30 = *local_2c - bVar15;
          local_30 = local_30 + 1;
          local_2c = local_2c + 1;
          local_28 = (byte *)((int)local_28 + -1);
        } while (local_28 != (byte *)0x0);
      }
      local_20 = *(byte **)(pbVar3 + 0xfc);
      goto LAB_004cedff;
    }
  }
  if ((char)bVar2 < '\0') {
    local_30 = local_10;
    if (pbVar3[0x1f8] == 2) {
      uVar18 = (uint)local_10 & 0xffff;
      uVar17 = (uint)local_10 >> 10 & 0x3fffc0;
      iVar9 = 0;
      if (uVar16 != 0) {
        do {
          if (*(char *)(iVar9 + *(int *)(pbVar3 + 0x1fc)) == '\x04') {
            uVar5 = (uint)*(ushort *)(*(int *)(pbVar3 + 0x204) + iVar9 * 2);
            uVar18 = uVar5 * uVar18 >> 8;
            uVar17 = uVar5 * uVar17 >> 8;
          }
          iVar9 = iVar9 + 1;
        } while (iVar9 < (int)uVar16);
      }
      uVar17 = *(ushort *)(*(int *)(pbVar3 + 0x20c) + 8) * uVar17 >> 3;
      if (uVar17 < 0x3fffc1) {
        local_30 = (byte *)((*(ushort *)(*(int *)(pbVar3 + 0x20c) + 8) * uVar18 >> 3) +
                           uVar17 * 0x400);
      }
      else {
        local_30 = (byte *)0x7fffffff;
      }
    }
    local_28 = (byte *)0x0;
    pbVar8 = pbVar8 + 1;
    local_2c = (byte *)0x0;
    param_1 = pbVar8;
    pbVar11 = (byte *)(*(int *)(pbVar3 + 0xfc) + 1);
    pbVar10 = (byte *)(iVar13 + 1);
    for (pbVar21 = pbVar20; pbVar21 != (byte *)0x0; pbVar21 = pbVar21 + -1) {
      bVar2 = *param_1;
      bVar4 = *pbVar10;
      *pbVar11 = bVar2 - bVar4;
      uVar17 = (uint)(byte)(bVar2 - bVar4);
      pbVar10 = pbVar10 + 1;
      param_1 = param_1 + 1;
      if (0x7f < uVar17) {
        uVar17 = 0x100 - uVar17;
      }
      local_28 = local_28 + uVar17;
      pbVar11 = pbVar11 + 1;
      local_2c = pbVar20;
    }
    if (local_2c < pbVar7) {
      iVar13 = (iVar13 + 1) - (int)pbVar8;
      do {
        bVar2 = *pbVar10;
        pbVar10 = pbVar10 + 1;
        bVar4 = pbVar8[iVar13];
        bVar15 = *pbVar8;
        pbVar8 = pbVar8 + 1;
        iVar9 = (uint)bVar2 - (uint)bVar4;
        iVar14 = (uint)bVar15 - (uint)bVar4;
        local_24 = iVar9;
        if (iVar9 < 0) {
          local_24 = -iVar9;
        }
        iVar22 = iVar14;
        if (iVar14 < 0) {
          iVar22 = -iVar14;
        }
        iVar9 = iVar9 + iVar14;
        if (iVar9 < 0) {
          iVar9 = -iVar9;
        }
        if (((iVar22 < local_24) || (iVar9 < local_24)) && (bVar15 = bVar4, iVar22 <= iVar9)) {
          bVar15 = bVar2;
        }
        bVar2 = *param_1;
        *pbVar11 = bVar2 - bVar15;
        uVar17 = (uint)(byte)(bVar2 - bVar15);
        pbVar11 = pbVar11 + 1;
        param_1 = param_1 + 1;
        if (0x7f < uVar17) {
          uVar17 = 0x100 - uVar17;
        }
        local_28 = local_28 + uVar17;
      } while ((local_28 <= local_30) && (local_2c = local_2c + 1, local_2c < pbVar7));
    }
    if (pbVar3[0x1f8] == 2) {
      uVar17 = (uint)local_28 >> 10 & 0x3fffc0;
      uVar18 = (uint)local_28 & 0xffff;
      iVar13 = 0;
      if (uVar16 != 0) {
        do {
          if (*(char *)(iVar13 + *(int *)(pbVar3 + 0x1fc)) == '\x04') {
            uVar5 = (uint)*(ushort *)(*(int *)(pbVar3 + 0x200) + iVar13 * 2);
            uVar18 = uVar5 * uVar18 >> 8;
            uVar17 = uVar5 * uVar17 >> 8;
          }
          iVar13 = iVar13 + 1;
        } while (iVar13 < (int)uVar16);
      }
      uVar17 = *(ushort *)(*(int *)(pbVar3 + 0x208) + 8) * uVar17 >> 3;
      if (uVar17 < 0x3fffc1) {
        local_28 = (byte *)((*(ushort *)(*(int *)(pbVar3 + 0x208) + 8) * uVar18 >> 3) +
                           uVar17 * 0x400);
      }
      else {
        local_28 = (byte *)0x7fffffff;
      }
    }
    if (local_28 < local_10) {
      local_20 = *(byte **)(pbVar3 + 0xfc);
    }
  }
LAB_004cedff:
  ImageDecoder_AdjustColors((uint)pbVar3,(int)local_20);
  if (pbVar3[0x1f9] != 0) {
    iVar13 = 1;
    if (1 < uVar16) {
      do {
        puVar1 = (undefined1 *)(iVar13 + *(int *)(pbVar3 + 0x1fc));
        iVar13 = iVar13 + 1;
        *puVar1 = puVar1[-1];
      } while (iVar13 < (int)uVar16);
    }
    *(byte *)(iVar13 + *(int *)(pbVar3 + 0x1fc)) = *local_20;
  }
  return;
}


