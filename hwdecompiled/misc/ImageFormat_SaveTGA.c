/*
 * Function: ImageFormat_SaveTGA
 * Address: 004bc370
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


undefined4 __thiscall ImageFormat_SaveTGA(void *this,int param_1,int param_2)

{
  int in_EAX;
  int iVar1;
  uint uVar2;
  uint uVar3;
  uint *puVar4;
  void *extraout_ECX;
  void *extraout_ECX_00;
  int extraout_ECX_01;
  void *extraout_ECX_02;
  void *extraout_ECX_03;
  void *extraout_ECX_04;
  uint extraout_EDX;
  uint extraout_EDX_00;
  int *piVar5;
  uint uVar6;
  uint uVar7;
  bool bVar8;
  undefined8 uVar9;
  undefined4 local_38;
  int local_34;
  undefined4 local_30;
  int local_2c;
  uint local_28;
  uint local_24;
  undefined4 local_20;
  undefined4 local_1c;
  int local_18;
  int local_14;
  undefined4 local_10;
  undefined4 local_c;
  void *local_8;
  
  local_18 = 0;
  local_14 = 0;
  local_10 = 0;
  local_c = 0;
  local_38 = 0;
  local_34 = 0;
  local_30 = 0;
  local_2c = 0;
  local_28 = 0;
  local_24 = 0;
  local_20 = 0;
  local_1c = 0;
  local_8 = (void *)0x0;
LAB_004bc3a4:
  if (*(int *)(in_EAX + 0x40) == 4) {
    while( true ) {
      iVar1 = CPU_ExecuteWithBufferWrapper(*(void **)(in_EAX + 0x60));
      uVar7 = local_24;
      uVar6 = local_28;
      this = extraout_ECX;
      if (iVar1 < 0) {
        local_8 = (void *)0xfffffffd;
        goto LAB_004bc60d;
      }
      if (iVar1 < 1) break;
      iVar1 = CPU_ProcessData9((int *)(in_EAX + 0xb8),&local_38,1);
      if (iVar1 == 0) {
        iVar1 = CPU_ProcessData20(in_EAX + 0x68,(undefined4 *)0x0);
        if (iVar1 == 0) {
          CPU_ProcessData19(in_EAX + 0x68,(int *)(in_EAX + 0xb8));
          uVar2 = CPU_ProcessData20(in_EAX + 0x68,(undefined4 *)0x0);
          *(int *)(in_EAX + 0x5c) =
               *(int *)(in_EAX + 0x5c) + ((int)uVar2 >> 0x1f) +
               (uint)CARRY4(*(uint *)(in_EAX + 0x58),uVar2);
          uVar3 = local_34 * 8;
          *(uint *)(in_EAX + 0x58) = *(uint *)(in_EAX + 0x58) + uVar2;
          uVar2 = *(uint *)(in_EAX + 0x50);
          this = (void *)(uVar2 + uVar3);
          *(void **)(in_EAX + 0x50) = this;
          *(uint *)(in_EAX + 0x54) =
               *(int *)(in_EAX + 0x54) + ((int)uVar3 >> 0x1f) + (uint)CARRY4(uVar2,uVar3);
          if (((uVar6 & uVar7) != 0xffffffff) && (local_2c == 0)) {
            if (*(int *)(in_EAX + 4) == 0) {
              local_8 = (void *)0x0;
            }
            else {
              local_8 = *(void **)(in_EAX + 0x48);
              if (0 < (int)local_8) {
                uVar2 = *(uint *)((int)local_8 * 0x10 + *(int *)(in_EAX + 0x2c));
                bVar8 = uVar6 < uVar2;
                uVar6 = uVar6 - uVar2;
                uVar7 = (uVar7 - *(int *)((int)local_8 * 0x10 + 4 + *(int *)(in_EAX + 0x2c))) -
                        (uint)bVar8;
              }
            }
            if (((int)uVar7 < 1) && ((int)uVar7 < 0)) {
              uVar6 = 0;
              uVar7 = 0;
            }
            uVar2 = CPU_ProcessData20(in_EAX + 0x68,(undefined4 *)0x0);
            uVar3 = uVar6 - uVar2;
            iVar1 = (uVar7 - ((int)uVar2 >> 0x1f)) - (uint)(uVar6 < uVar2);
            if (0 < (int)local_8) {
              puVar4 = (uint *)(*(int *)(in_EAX + 0x2c) + 8);
              do {
                bVar8 = CARRY4(uVar3,*puVar4);
                uVar3 = uVar3 + *puVar4;
                iVar1 = iVar1 + puVar4[1] + (uint)bVar8;
                puVar4 = puVar4 + 4;
                local_8 = (void *)((int)local_8 + -1);
              } while (local_8 != (void *)0x0);
            }
            *(uint *)(in_EAX + 0x38) = uVar3;
            *(int *)(in_EAX + 0x3c) = iVar1;
            this = local_8;
          }
          local_8 = (void *)0x1;
        }
        else {
          local_8 = (void *)0xffffff7f;
          this = extraout_ECX_04;
        }
        goto LAB_004bc60d;
      }
    }
  }
  if (1 < *(int *)(in_EAX + 0x40)) {
    if ((param_1 == 0) ||
       (uVar9 = ImageFormat_LoadJPEG(&local_18,0xffffffff,-1), this = extraout_ECX_00,
       (int)uVar9 < 0)) goto LAB_004bc60d;
    uVar6 = *(uint *)(in_EAX + 0x50);
    uVar7 = local_14 * 8;
    iVar1 = *(int *)(in_EAX + 0x40);
    *(uint *)(in_EAX + 0x50) = uVar6 + uVar7;
    *(uint *)(in_EAX + 0x54) =
         *(int *)(in_EAX + 0x54) + ((int)uVar7 >> 0x1f) + (uint)CARRY4(uVar6,uVar7);
    if (iVar1 != 4) goto LAB_004bc47c;
    uVar9 = CPU_ExecuteInstruction14();
    this = *(void **)(in_EAX + 0x44);
    if (this != (void *)uVar9) {
      if (param_2 != 0) {
        ImageFormat_SavePNG(this,(uint)((ulonglong)uVar9 >> 0x20));
        if (*(int *)(in_EAX + 4) == 0) {
          CPU_ProcessData4(extraout_ECX_01,extraout_EDX,*(undefined4 **)(in_EAX + 0x30));
          CPU_ProcessData2(*(int *)(in_EAX + 0x34),extraout_EDX_00,(int *)*(int *)(in_EAX + 0x34));
        }
        goto LAB_004bc474;
      }
      goto LAB_004bc60d;
    }
  }
LAB_004bc474:
  iVar1 = *(int *)(in_EAX + 0x40);
  if (iVar1 != 4) goto LAB_004bc47c;
LAB_004bc4f8:
  CPU_ValidateAndProcess(*(int **)(in_EAX + 0x60),&local_18);
  this = extraout_ECX_03;
  goto LAB_004bc3a4;
LAB_004bc47c:
  if (iVar1 < 3) {
    if (*(int *)(in_EAX + 4) == 0) {
      iVar1 = ImageFormat_LoadDDS(*(undefined4 **)(in_EAX + 0x30),*(undefined4 **)(in_EAX + 0x34),
                                  &local_18);
      this = extraout_ECX_02;
      if (iVar1 != 0) goto LAB_004bc60d;
      *(int *)(in_EAX + 0x48) = *(int *)(in_EAX + 0x48) + 1;
    }
    else {
      iVar1 = CPU_ExecuteInstruction14();
      this = (void *)0x0;
      *(int *)(in_EAX + 0x44) = iVar1;
      if (0 < (int)*(void **)(in_EAX + 0x1c)) {
        piVar5 = *(int **)(in_EAX + 0x28);
        do {
          if (*piVar5 == iVar1) break;
          this = (void *)((int)this + 1);
          piVar5 = piVar5 + 1;
        } while ((int)this < *(int *)(in_EAX + 0x1c));
      }
      if (this == *(void **)(in_EAX + 0x1c)) {
        local_8 = (void *)0xffffff77;
LAB_004bc60d:
        CPU_ClearContext8(this,&local_38);
        CPU_ClearContext4(&local_18,&local_18);
        return local_8;
      }
      *(void **)(in_EAX + 0x48) = this;
      CPU_InitializeWithParam(this,*(undefined4 **)(in_EAX + 0x60),iVar1);
      *(undefined4 *)(in_EAX + 0x40) = 3;
    }
  }
  ImageFormat_SaveJPEG();
  goto LAB_004bc4f8;
}


