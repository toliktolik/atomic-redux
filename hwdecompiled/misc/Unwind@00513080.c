/*
 * Function: Unwind@00513080
 * Address: 00513080
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


/* WARNING: Control flow encountered bad instruction data */
/* WARNING: Instruction at (ram,0x005130c6) overlaps instruction at (ram,0x005130c5)
    */
/* WARNING: Unable to track spacebase fully for stack */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void __fastcall Unwind_00513080(int *param_1,undefined2 *param_2)

{
  ushort *puVar1;
  int *piVar2;
  code *pcVar3;
  byte bVar4;
  char cVar5;
  byte bVar6;
  undefined4 uVar7;
  uint uVar8;
  int iVar9;
  undefined2 uVar10;
  int iVar11;
  int unaff_EBX;
  undefined4 *unaff_EBP;
  undefined4 *puVar12;
  uint unaff_ESI;
  undefined4 *unaff_EDI;
  undefined4 *puVar13;
  byte in_DS;
  bool bVar14;
  byte bVar15;
  byte in_AF;
  bool in_OF;
  bool bVar16;
  undefined2 in_FPUControlWord;
  undefined2 in_FPUStatusWord;
  undefined2 in_FPUTagWord;
  undefined2 in_FPULastInstructionOpcode;
  undefined4 in_FPUDataPointer;
  undefined4 in_FPUInstructionPointer;
  unkbyte10 extraout_ST0;
  unkbyte10 extraout_ST0_00;
  unkbyte10 in_ST0;
  unkbyte10 extraout_ST1;
  unkbyte10 extraout_ST1_00;
  unkbyte10 in_ST1;
  unkbyte10 in_ST2;
  unkbyte10 in_ST3;
  unkbyte10 in_ST4;
  unkbyte10 in_ST5;
  unkbyte10 in_ST6;
  unkbyte10 in_ST7;
  undefined8 uVar17;
  undefined4 uStack_4;
  
  bVar15 = 9 < (in_DS & 0xf) | in_AF;
  uStack_4 = _DAT_c57d56e8;
  if (in_OF) {
    uVar7 = in((short)param_2);
    bVar6 = (byte)uVar7;
    out((short)param_2,bVar6);
    bVar14 = CARRY1(bVar6,(byte)param_1);
    iVar9 = CONCAT31((int3)((uint)uVar7 >> 8),bVar6 + (byte)param_1);
    bVar16 = SBORROW4(unaff_ESI,1);
    unaff_ESI = unaff_ESI - 1;
    puVar13 = unaff_EDI;
    if (bVar16) {
                    /* WARNING: Bad instruction - Truncating control flow here */
      halt_baddata();
    }
    while( true ) {
      puVar12 = unaff_EBP;
      iVar9 = iVar9 + *param_1 + (uint)bVar14;
      bVar6 = (byte)iVar9;
      out(0x43,bVar6);
      uVar7 = in((short)param_2);
      *puVar13 = uVar7;
      if (iVar9 < 0) {
                    /* WARNING: Bad instruction - Truncating control flow here */
        halt_baddata();
      }
      cVar5 = (char)((uint)unaff_EBX >> 8);
      iVar11 = CONCAT22((short)((uint)unaff_EBX >> 0x10),CONCAT11(cVar5 - bVar6,(char)unaff_EBX));
      if ((byte)(cVar5 - bVar6) != '\0') break;
      unaff_EBP = (undefined4 *)(*(int *)((int)puVar13 + 0x1e) * -0x37);
      uVar8 = CONCAT31((int3)(CONCAT22((short)((uint)iVar9 >> 0x10),CONCAT11(bVar6 / 0x82,bVar6)) >>
                             8),bVar6 % 0x82) & 0xffffffa9;
      uVar10 = CONCAT11(0xb1,(char)param_2);
      param_2 = (undefined2 *)CONCAT22((short)((uint)param_2 >> 0x10),uVar10);
      bVar14 = uVar8 < 0x3a82b6b7;
      iVar9 = in(uVar10);
      if (SBORROW4(uVar8,0x3a82b6b7)) {
        bVar14 = CARRY4(unaff_ESI,(uint)&uStack_4);
        unaff_ESI = (int)&uStack_4 + unaff_ESI;
      }
      else {
        *(undefined2 *)(unaff_EBP + -0xf18c810) = in_FPUControlWord;
        iVar9 = _DAT_43770101;
        if (SBORROW4((int)&uStack_4,1)) {
          *(char *)((int)param_1 + 0x16d3ecff) =
               (*(char *)((int)param_1 + 0x16d3ecff) + 'O') - bVar14;
          *puVar12 = param_2;
          return;
        }
      }
      unaff_EBX = CONCAT31((int3)((uint)iVar11 >> 8),0xbe) + 1;
      puVar13 = puVar12;
    }
    if ((char)bVar6 <= cVar5) {
                    /* WARNING: Bad instruction - Truncating control flow here */
      halt_baddata();
    }
    bVar4 = in((short)param_2);
    uVar17 = CONCAT44(param_2,CONCAT31((int3)((uint)iVar9 >> 8),
                                       *(undefined1 *)(iVar11 + (uint)bVar4)));
    pcVar3 = (code *)swi(4);
    if (SBORROW1(cVar5,bVar6)) {
      uVar17 = (*pcVar3)();
      in_ST0 = extraout_ST0;
      in_ST1 = extraout_ST1;
    }
    unaff_EDI = (undefined4 *)((int)puVar13 + -5);
    pcVar3 = (code *)swi(4);
    if (SBORROW4((int)(puVar13 + -1),1)) {
      uVar17 = (*pcVar3)();
      in_ST0 = extraout_ST0_00;
      in_ST1 = extraout_ST1_00;
    }
    param_2 = (undefined2 *)((ulonglong)uVar17 >> 0x20);
    *param_2 = in_FPUControlWord;
    param_2[2] = in_FPUStatusWord;
    param_2[4] = in_FPUTagWord;
    *(undefined4 *)(param_2 + 10) = in_FPUDataPointer;
    *(undefined4 *)(param_2 + 6) = in_FPUInstructionPointer;
    param_2[9] = in_FPULastInstructionOpcode;
    *(unkbyte10 *)(param_2 + 0xe) = in_ST0;
    *(unkbyte10 *)(param_2 + 0x13) = in_ST1;
    *(unkbyte10 *)(param_2 + 0x18) = in_ST2;
    *(unkbyte10 *)(param_2 + 0x1d) = in_ST3;
    *(unkbyte10 *)(param_2 + 0x22) = in_ST4;
    *(unkbyte10 *)(param_2 + 0x27) = in_ST5;
    *(unkbyte10 *)(param_2 + 0x2c) = in_ST6;
    *(unkbyte10 *)(param_2 + 0x31) = in_ST7;
    piVar2 = puVar12 + -0xd433157;
    iVar9 = *piVar2;
    *piVar2 = -*piVar2;
    bVar6 = (byte)puVar12 - *(byte *)(puVar13 + -0x13);
    bVar14 = (byte)puVar12 < *(byte *)(puVar13 + -0x13) || bVar6 < (iVar9 != 0);
    cVar5 = bVar6 - (iVar9 != 0);
    if (bVar14 || cVar5 == '\0') {
                    /* WARNING: Bad instruction - Truncating control flow here */
      halt_baddata();
    }
    DAT_35434cac = cVar5 + ((cVar5 == '\0') << 6 | bVar15 << 4 | ((POPCOUNT(cVar5) & 1U) == 0) << 2
                            | 2 | bVar14) * '.';
    *(byte *)(unaff_ESI + 0x65) =
         *(byte *)(unaff_ESI + 0x65) ^ (byte)*(undefined4 *)((int)uVar17 + 0x50);
    out((short)((ulonglong)uVar17 >> 0x20),DAT_35434cac);
  }
  uVar7 = in((short)param_2);
  _DAT_55f22b5b = CONCAT31((int3)((uint)uVar7 >> 8),(byte)uVar7 - 0x38);
  puVar1 = (ushort *)(unaff_ESI + 0x8d);
  *puVar1 = *puVar1 + (ushort)((byte)uVar7 < 0x38) *
                      (((ushort)(undefined1 *)((int)unaff_EDI + -1) & 3) - (*puVar1 & 3));
  _DAT_dc3b0d8e = _DAT_55f22b5b;
  *(undefined1 *)((int)unaff_EDI + -1) = *(undefined1 *)(unaff_ESI - 4);
  pcVar3 = (code *)swi(3);
  (*pcVar3)();
  return;
}


