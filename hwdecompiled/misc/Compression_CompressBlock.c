/*
 * Function: Compression_CompressBlock
 * Address: 004dc800
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __cdecl Compression_CompressBlock(int param_1,undefined1 *param_2,int param_3,int param_4)

{
  int iVar1;
  byte bVar2;
  uint uVar3;
  undefined4 extraout_ECX;
  undefined4 extraout_ECX_00;
  undefined4 extraout_ECX_01;
  undefined4 uVar4;
  uint uVar5;
  int iVar6;
  undefined4 local_8;
  
  local_8 = 0;
  if (*(int *)(param_1 + 0x7c) < 1) {
    uVar3 = param_3 + 5;
  }
  else {
    if (*(char *)(param_1 + 0x1c) == '\x02') {
      Huffman_DetermineStrategy(param_1);
    }
    Huffman_BuildTree((int *)(param_1 + 0xb10));
    Huffman_BuildTree((int *)(param_1 + 0xb1c));
    local_8 = Huffman_PrepareTrees();
    uVar5 = *(int *)(param_1 + 0x16a0) + 10U >> 3;
    uVar3 = *(int *)(param_1 + 0x16a4) + 10U >> 3;
    if (uVar5 < uVar3) goto LAB_004dc870;
  }
  uVar5 = uVar3;
LAB_004dc870:
  if ((uVar5 < param_3 + 4U) || (param_2 == (undefined1 *)0x0)) {
    iVar6 = *(int *)(param_1 + 0x16b4);
    bVar2 = (byte)iVar6;
    if (uVar3 == uVar5) {
      iVar1 = param_4 + 2;
      if (iVar6 < 0xe) {
        *(ushort *)(param_1 + 0x16b0) =
             *(ushort *)(param_1 + 0x16b0) | (ushort)(iVar1 << (bVar2 & 0x1f));
        *(int *)(param_1 + 0x16b4) = iVar6 + 3;
      }
      else {
        *(ushort *)(param_1 + 0x16b0) =
             *(ushort *)(param_1 + 0x16b0) | (ushort)(iVar1 << (bVar2 & 0x1f));
        *(undefined1 *)(*(int *)(param_1 + 8) + *(int *)(param_1 + 0x14)) =
             *(undefined1 *)(param_1 + 0x16b0);
        iVar6 = *(int *)(param_1 + 0x14) + 1;
        *(int *)(param_1 + 0x14) = iVar6;
        *(undefined1 *)(iVar6 + *(int *)(param_1 + 8)) = *(undefined1 *)(param_1 + 0x16b1);
        iVar6 = *(int *)(param_1 + 0x16b4);
        *(int *)(param_1 + 0x14) = *(int *)(param_1 + 0x14) + 1;
        *(int *)(param_1 + 0x16b4) = iVar6 + -0xd;
        *(ushort *)(param_1 + 0x16b0) = (ushort)iVar1 >> (0x10U - (char)iVar6 & 0x1f);
      }
      Huffman_EncodeCompressedBlock(0x542f88,0x543408);
      uVar4 = extraout_ECX_00;
    }
    else {
      iVar1 = param_4 + 4;
      if (iVar6 < 0xe) {
        *(ushort *)(param_1 + 0x16b0) =
             *(ushort *)(param_1 + 0x16b0) | (ushort)(iVar1 << (bVar2 & 0x1f));
        *(int *)(param_1 + 0x16b4) = iVar6 + 3;
      }
      else {
        *(ushort *)(param_1 + 0x16b0) =
             *(ushort *)(param_1 + 0x16b0) | (ushort)(iVar1 << (bVar2 & 0x1f));
        *(undefined1 *)(*(int *)(param_1 + 8) + *(int *)(param_1 + 0x14)) =
             *(undefined1 *)(param_1 + 0x16b0);
        iVar6 = *(int *)(param_1 + 0x14) + 1;
        *(int *)(param_1 + 0x14) = iVar6;
        *(undefined1 *)(iVar6 + *(int *)(param_1 + 8)) = *(undefined1 *)(param_1 + 0x16b1);
        *(int *)(param_1 + 0x14) = *(int *)(param_1 + 0x14) + 1;
        iVar6 = *(int *)(param_1 + 0x16b4);
        *(int *)(param_1 + 0x16b4) = iVar6 + -0xd;
        *(ushort *)(param_1 + 0x16b0) = (ushort)iVar1 >> (0x10U - (char)iVar6 & 0x1f);
      }
      Huffman_EncodeLiteralLengthCounts
                (*(int *)(param_1 + 0xb14) + 1,*(int *)(param_1 + 0xb20) + 1,local_8 + 1);
      Huffman_EncodeCompressedBlock(param_1 + 0x8c,param_1 + 0x980);
      uVar4 = extraout_ECX_01;
    }
  }
  else {
    Compression_WriteStoredBlock(param_1,param_2,param_3,param_4);
    uVar4 = extraout_ECX;
  }
  Huffman_InitializeStatistics(uVar4,param_1);
  if (param_4 != 0) {
    BitStream_FlushBuffer();
  }
  return;
}


