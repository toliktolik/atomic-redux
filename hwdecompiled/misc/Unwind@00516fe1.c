/*
 * Function: Unwind@00516fe1
 * Address: 00516fe1
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


/* WARNING: Control flow encountered bad instruction data */
/* WARNING: Instruction at (ram,0x00516ff6) overlaps instruction at (ram,0x00516ff2)
    */
/* WARNING: Unable to track spacebase fully for stack */
/* WARNING: Removing unreachable block (ram,0x00517054) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void __fastcall Unwind_00516fe1(int param_1,byte *param_2,uint param_3,undefined1 *param_4)

{
  char *pcVar1;
  char cVar2;
  undefined1 *puVar4;
  short sVar5;
  code *pcVar6;
  uint uVar7;
  short sVar8;
  int iVar9;
  byte *pbVar11;
  char cVar12;
  int unaff_EBP;
  undefined1 *unaff_ESI;
  uint uVar13;
  undefined2 in_DS;
  undefined2 in_GS;
  bool bVar14;
  bool bVar15;
  undefined2 in_FPUControlWord;
  undefined2 in_FPUStatusWord;
  undefined2 in_FPUTagWord;
  undefined2 in_FPULastInstructionOpcode;
  undefined4 in_FPUDataPointer;
  undefined4 in_FPUInstructionPointer;
  float10 in_ST0;
  float10 in_ST1;
  float10 in_ST2;
  float10 in_ST3;
  float10 in_ST4;
  float10 in_ST5;
  float10 in_ST6;
  float10 fVar16;
  float10 in_ST7;
  uint *unaff_retaddr;
  char cVar3;
  uint *puVar10;
  
  while( true ) {
    fVar16 = in_ST6;
    in_ST6 = in_ST5;
    in_ST5 = in_ST4;
    in_ST4 = in_ST3;
    in_ST3 = in_ST2;
    in_ST2 = in_ST1;
    in_ST1 = in_ST0;
    iVar9 = param_1 + -1;
    LOCK();
    puVar4 = *(undefined1 **)(param_2 + 0x11);
    *(undefined1 **)(param_2 + 0x11) = unaff_ESI;
    UNLOCK();
    pbVar11 = (byte *)CONCAT22((short)((uint)param_2 >> 0x10),CONCAT11(0x53,(char)param_2));
    unaff_ESI = puVar4;
    while( true ) {
      bVar14 = (param_3 & 0x40) != 0;
      bVar15 = (param_3 & 1) != 0;
      if (bVar14) {
        *(undefined2 *)pbVar11 = in_GS;
        pcVar6 = (code *)swi(1);
        (*pcVar6)();
        return;
      }
      iVar9 = iVar9 + -1;
      if (iVar9 != 0 && bVar14) break;
      uVar13 = (uint)bVar15;
      bVar15 = CARRY4((uint)unaff_retaddr,(uint)unaff_retaddr);
      bVar14 = SCARRY4((int)unaff_retaddr,(int)unaff_retaddr);
      uVar7 = (int)unaff_retaddr * 2;
      unaff_retaddr = (uint *)(uVar7 + uVar13);
      unaff_EBP = (int)_DAT_be6a9e40;
      *unaff_retaddr =
           *unaff_retaddr << 0xe |
           (uint)(CONCAT14((unaff_retaddr == (uint *)0x0 ||
                           (bVar14 != SCARRY4(uVar7,uVar13)) != (int)unaff_retaddr < 0) &&
                           (bVar15 || CARRY4(uVar7,uVar13)),*unaff_retaddr) >> 0x13);
      unaff_ESI = param_4;
    }
    sVar5 = ((ushort)unaff_ESI & 3) - ((ushort)iVar9 & 3);
    sVar8 = (ushort)iVar9 + (ushort)bVar15 * sVar5;
    puVar10 = (uint *)CONCAT22((short)((uint)iVar9 >> 0x10),sVar8);
    uVar13 = *puVar10;
    uRamadc41f0c = in_FPUControlWord;
    uRamadc41f10 = in_FPUStatusWord;
    uRamadc41f14 = in_FPUTagWord;
    uRamadc41f18 = in_FPUInstructionPointer;
    uRamadc41f1e = in_FPULastInstructionOpcode;
    uRamadc41f20 = in_FPUDataPointer;
    fRamadc41f28 = in_ST1;
    fRamadc41f32 = in_ST2;
    fRamadc41f3c = in_ST3;
    fRamadc41f46 = in_ST4;
    fRamadc41f50 = in_ST5;
    fRamadc41f5a = in_ST6;
    fRamadc41f64 = fVar16;
    fRamadc41f6e = in_ST7;
    *puVar10 = *puVar10 << 1 | (uint)((int)uVar13 < 0);
    if ((int)uVar13 >= 0 && sVar5 < 1) {
      pcVar6 = (code *)swi(1);
      (*pcVar6)();
      return;
    }
    iVar9 = *(int *)pbVar11;
    param_2 = (byte *)CONCAT31(0x58fad8,*(byte *)(unaff_EBP + -0x19) | 0xcb);
    cVar12 = '+';
    uVar13 = (uint)unaff_retaddr | *puVar10;
    *(uint *)(uVar13 - 0x1b) = *(uint *)(uVar13 - 0x1b) ^ 0xe4c50d2b;
    _DAT_0a02db66 = _DAT_0a02db66 & 0xe4c50d2b;
    bVar15 = SCARRY4(unaff_EBP,1);
    unaff_EBP = unaff_EBP + 1;
    out(0x92,pbVar11);
    if (bVar15 == unaff_EBP < 0) break;
    cVar12 = '$';
    pcVar1 = unaff_ESI + 5;
    *pcVar1 = *pcVar1 + (char)sVar8;
    param_1 = (int)puVar10 + -1;
    if (param_1 == 0 || *pcVar1 != '\0') goto code_r0x0051701c;
    unaff_retaddr = (uint *)CONCAT22((short)((uint)unaff_retaddr >> 0x10),in_DS);
    in_FPUControlWord = 0x37f;
    in_FPUStatusWord = 0;
    in_FPUTagWord = 0xffff;
    in_FPULastInstructionOpcode = 0;
    in_FPUDataPointer = 0;
    in_FPUInstructionPointer = 0;
    in_ST0 = (float10)iVar9;
    in_ST7 = fVar16;
  }
  uVar13 = uVar13 + 1;
code_r0x0051701c:
  out(*unaff_ESI,(short)param_2);
  bVar15 = (byte)uVar13 < *pbVar11;
  pcVar1 = unaff_ESI + 0x1e;
  cVar2 = *pcVar1;
  cVar3 = *pcVar1;
  *pcVar1 = cVar3 + cVar12 + bVar15;
  if ((SCARRY1(cVar2,cVar12) != SCARRY1(cVar3 + cVar12,bVar15)) == *pcVar1 < '\0') {
    *(double *)(param_2 + 0x44) = (double)iVar9;
    *(undefined4 *)(uVar13 - 4) = 0xf;
    *(uint *)(uVar13 - 8) = uVar13 - 4;
                    /* WARNING: Bad instruction - Truncating control flow here */
    halt_baddata();
  }
  *(int *)(unaff_ESI + 1) = unaff_EBP;
  pcVar6 = (code *)swi(3);
  (*pcVar6)();
  return;
}


