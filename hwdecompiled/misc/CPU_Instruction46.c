/*
 * Function: CPU_Instruction46
 * Address: 004ca330
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


void __fastcall CPU_Instruction46(uint param_1,byte *param_2,uint param_3,int param_4,uint param_5)

{
  byte *pbVar1;
  byte bVar2;
  byte bVar3;
  byte *pbVar4;
  int iVar5;
  undefined4 uVar6;
  undefined4 uVar7;
  uint uVar8;
  void *pvVar9;
  undefined4 extraout_ECX;
  undefined4 extraout_ECX_00;
  int extraout_ECX_01;
  undefined4 extraout_ECX_02;
  int extraout_ECX_03;
  undefined4 extraout_ECX_04;
  byte *pbVar10;
  int extraout_ECX_05;
  int extraout_ECX_06;
  int extraout_ECX_07;
  int extraout_ECX_08;
  byte *extraout_EDX;
  byte *extraout_EDX_00;
  byte *extraout_EDX_01;
  byte *extraout_EDX_02;
  byte *extraout_EDX_03;
  byte *pbVar11;
  uint extraout_EDX_04;
  byte *extraout_EDX_05;
  byte *extraout_EDX_06;
  uint extraout_EDX_07;
  uint extraout_EDX_08;
  uint extraout_EDX_09;
  byte *pbVar12;
  byte *pbVar13;
  char *pcVar14;
  
  if ((*(uint *)(param_3 + 0x68) & 1) == 0) {
    CPU_Instruction20(param_1,param_2,param_3,"Missing IHDR before pCAL");
  }
  else {
    if ((*(uint *)(param_3 + 0x68) & 4) != 0) {
      CPU_Instruction21(param_1,param_2,param_3,"Invalid pCAL after IDAT");
      CPU_Instruction33(extraout_ECX_02,extraout_EDX_02,param_3,param_5);
      return;
    }
    if ((param_4 != 0) && ((*(uint *)(param_4 + 8) & 0x400) != 0)) {
      CPU_Instruction21(*(uint *)(param_4 + 8),param_2,param_3,"Duplicate pCAL chunk");
      CPU_Instruction33(param_5,extraout_EDX_03,param_3,param_5);
      return;
    }
  }
  pbVar4 = (byte *)CPU_Instruction12(param_3,param_5 + 1);
  CPU_Instruction26(extraout_ECX,extraout_EDX,param_3,pbVar4,param_5);
  iVar5 = CPU_Instruction33(extraout_ECX_00,extraout_EDX_00,param_3,0);
  if (iVar5 != 0) {
    CPU_Instruction13(extraout_ECX_01,(uint)extraout_EDX_01,param_3,(int)pbVar4);
    return;
  }
  pbVar11 = pbVar4 + param_5;
  *pbVar11 = 0;
  bVar3 = *pbVar4;
  pbVar12 = pbVar4;
  while (bVar3 != 0) {
    pbVar10 = pbVar12 + 1;
    pbVar12 = pbVar12 + 1;
    bVar3 = *pbVar10;
  }
  pbVar10 = pbVar12 + 0xc;
  if (pbVar10 < pbVar11) {
    uVar6 = CPU_Instruction24(pbVar12 + 1);
    uVar7 = CPU_Instruction24(pbVar12 + 5);
    bVar3 = pbVar12[10];
    pbVar10 = (byte *)CONCAT31((int3)((uint)extraout_ECX_04 >> 8),bVar3);
    bVar2 = pbVar12[9];
    pbVar12 = pbVar12 + 0xb;
    if (bVar2 == 0) {
      if (bVar3 == 2) goto LAB_004ca486;
    }
    else if ((bVar2 == 1) || (bVar2 == 2)) {
      if (bVar3 == 3) goto LAB_004ca486;
    }
    else {
      if (bVar2 != 3) {
        if (3 < bVar2) {
          CPU_Instruction21(pbVar10,extraout_EDX_05,param_3,
                            "Unrecognized equation type for pCAL chunk");
          pbVar10 = (byte *)(uint)bVar3;
        }
LAB_004ca486:
        bVar3 = *pbVar12;
        pbVar13 = pbVar12;
        while (bVar3 != 0) {
          pbVar1 = pbVar13 + 1;
          pbVar13 = pbVar13 + 1;
          bVar3 = *pbVar1;
        }
        uVar8 = (uint)pbVar10 & 0xff;
        pvVar9 = CPU_Instruction12(param_3,uVar8 * 4);
        iVar5 = 0;
        pbVar10 = extraout_EDX_06;
        if (uVar8 != 0) {
          do {
            pbVar13 = pbVar13 + 1;
            *(byte **)((int)pvVar9 + iVar5 * 4) = pbVar13;
            bVar3 = *pbVar13;
            while (bVar3 != 0) {
              if (pbVar11 < pbVar13) goto LAB_004ca520;
              bVar3 = pbVar13[1];
              pbVar10 = (byte *)CONCAT31((int3)((uint)pbVar10 >> 8),bVar3);
              pbVar13 = pbVar13 + 1;
            }
            if (pbVar11 < pbVar13) {
LAB_004ca520:
              CPU_Instruction21(uVar8,pbVar10,param_3,"Invalid pCAL data");
              CPU_Instruction13(extraout_ECX_07,(uint)pbVar4,param_3,(int)pbVar4);
              CPU_Instruction13(extraout_ECX_08,extraout_EDX_09,param_3,(int)pvVar9);
              return;
            }
            iVar5 = iVar5 + 1;
          } while (iVar5 < (int)uVar8);
        }
        PNG_SetTextChunks(param_3,param_4,(char *)pbVar4,uVar6,uVar7,bVar2,uVar8,(char *)pbVar12,
                          (int)pvVar9);
        CPU_Instruction13(extraout_ECX_05,extraout_EDX_07,param_3,(int)pbVar4);
        CPU_Instruction13(extraout_ECX_06,extraout_EDX_08,param_3,(int)pvVar9);
        return;
      }
      if (bVar3 == 4) goto LAB_004ca486;
    }
    pcVar14 = "Invalid pCAL parameters for equation type";
    pbVar11 = extraout_EDX_05;
  }
  else {
    pcVar14 = "Invalid pCAL data";
    pbVar11 = extraout_EDX_01;
  }
  CPU_Instruction21(pbVar10,pbVar11,param_3,pcVar14);
  CPU_Instruction13(extraout_ECX_03,extraout_EDX_04,param_3,(int)pbVar4);
  return;
}


