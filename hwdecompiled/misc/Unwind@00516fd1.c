/*
 * Function: Unwind@00516fd1
 * Address: 00516fd1
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


/* WARNING: Control flow encountered bad instruction data */
/* WARNING: Instruction at (ram,0x00516ff6) overlaps instruction at (ram,0x00516ff2)
    */
/* WARNING: Unable to track spacebase fully for stack */
/* WARNING: Removing unreachable block (ram,0x00517054) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void __fastcall Unwind_00516fd1(undefined4 param_1,byte *param_2,uint param_3,undefined1 *param_4)

{
  undefined4 *puVar1;
  byte *pbVar2;
  char *pcVar3;
  undefined1 *puVar4;
  char cVar5;
  short sVar6;
  code *pcVar7;
  uint uVar8;
  byte *in_EAX;
  byte bVar9;
  short sVar10;
  int iVar11;
  char cVar13;
  int unaff_EBX;
  int unaff_EBP;
  undefined1 *unaff_ESI;
  uint uVar14;
  undefined2 in_DS;
  undefined2 in_GS;
  char in_CF;
  bool bVar15;
  bool bVar16;
  undefined2 in_FPUControlWord;
  undefined2 in_FPUStatusWord;
  undefined2 in_FPUTagWord;
  undefined2 in_FPULastInstructionOpcode;
  undefined4 in_FPUDataPointer;
  undefined4 in_FPUInstructionPointer;
  float10 in_ST0;
  float10 in_ST1;
  float10 in_ST2;
  float10 in_ST3;
  float10 in_ST4;
  float10 in_ST5;
  float10 in_ST6;
  float10 fVar17;
  float10 in_ST7;
  uint *unaff_retaddr;
  uint *puVar12;
  
  while( true ) {
    fVar17 = in_ST6;
    in_ST6 = in_ST5;
    in_ST5 = in_ST4;
    in_ST4 = in_ST3;
    in_ST3 = in_ST2;
    in_ST2 = in_ST1;
    in_ST1 = in_ST0;
    out(0xbc,in_EAX);
    cVar13 = ((char)param_2 - *(char *)(unaff_EBX + 0x1d1449b4)) - in_CF;
    iVar11 = 0x4eba7b47;
    LOCK();
    puVar1 = (undefined4 *)(CONCAT31((int3)((uint)param_2 >> 8),cVar13) + 0x11);
    puVar4 = (undefined1 *)*puVar1;
    *puVar1 = unaff_ESI;
    UNLOCK();
    in_EAX = (byte *)CONCAT22((short)((uint)param_2 >> 0x10),CONCAT11(0x53,cVar13));
    unaff_ESI = puVar4;
    while( true ) {
      bVar15 = (param_3 & 0x40) != 0;
      bVar16 = (param_3 & 1) != 0;
      if (bVar15) {
        *(undefined2 *)in_EAX = in_GS;
        pcVar7 = (code *)swi(1);
        (*pcVar7)();
        return;
      }
      iVar11 = iVar11 + -1;
      if (iVar11 != 0 && bVar15) break;
      uVar14 = (uint)bVar16;
      bVar16 = CARRY4((uint)unaff_retaddr,(uint)unaff_retaddr);
      bVar15 = SCARRY4((int)unaff_retaddr,(int)unaff_retaddr);
      uVar8 = (int)unaff_retaddr * 2;
      unaff_retaddr = (uint *)(uVar8 + uVar14);
      unaff_EBP = (int)_DAT_be6a9e40;
      *unaff_retaddr =
           *unaff_retaddr << 0xe |
           (uint)(CONCAT14((unaff_retaddr == (uint *)0x0 ||
                           (bVar15 != SCARRY4(uVar8,uVar14)) != (int)unaff_retaddr < 0) &&
                           (bVar16 || CARRY4(uVar8,uVar14)),*unaff_retaddr) >> 0x13);
      unaff_ESI = param_4;
    }
    sVar6 = ((ushort)unaff_ESI & 3) - ((ushort)iVar11 & 3);
    sVar10 = (ushort)iVar11 + (ushort)bVar16 * sVar6;
    puVar12 = (uint *)CONCAT22((short)((uint)iVar11 >> 0x10),sVar10);
    uVar14 = *puVar12;
    uRamadc41f0c = in_FPUControlWord;
    uRamadc41f10 = in_FPUStatusWord;
    uRamadc41f14 = in_FPUTagWord;
    uRamadc41f18 = in_FPUInstructionPointer;
    uRamadc41f1e = in_FPULastInstructionOpcode;
    uRamadc41f20 = in_FPUDataPointer;
    fRamadc41f28 = in_ST1;
    fRamadc41f32 = in_ST2;
    fRamadc41f3c = in_ST3;
    fRamadc41f46 = in_ST4;
    fRamadc41f50 = in_ST5;
    fRamadc41f5a = in_ST6;
    fRamadc41f64 = fVar17;
    fRamadc41f6e = in_ST7;
    *puVar12 = *puVar12 << 1 | (uint)((int)uVar14 < 0);
    if ((int)uVar14 >= 0 && sVar6 < 1) {
      pcVar7 = (code *)swi(1);
      (*pcVar7)();
      return;
    }
    iVar11 = *(int *)in_EAX;
    param_2 = (byte *)CONCAT31(0x58fad8,*(byte *)(unaff_EBP + -0x19) | 0xcb);
    unaff_EBX = -0x1b3af2d5;
    uVar14 = (uint)unaff_retaddr | *puVar12;
    *(uint *)(uVar14 - 0x1b) = *(uint *)(uVar14 - 0x1b) ^ 0xe4c50d2b;
    _DAT_0a02db66 = _DAT_0a02db66 & 0xe4c50d2b;
    bVar16 = SCARRY4(unaff_EBP,1);
    unaff_EBP = unaff_EBP + 1;
    out(0x92,in_EAX);
    if (bVar16 == unaff_EBP < 0) break;
    unaff_EBX = 0x1fa6a224;
    pbVar2 = unaff_ESI + 5;
    bVar9 = (byte)sVar10;
    in_CF = CARRY1(*pbVar2,bVar9);
    *pbVar2 = *pbVar2 + bVar9;
    if (puVar12 == (uint *)0x1 || *pbVar2 != 0) goto code_r0x0051701c;
    unaff_retaddr = (uint *)CONCAT22((short)((uint)unaff_retaddr >> 0x10),in_DS);
    in_FPUControlWord = 0x37f;
    in_FPUStatusWord = 0;
    in_FPUTagWord = 0xffff;
    in_FPULastInstructionOpcode = 0;
    in_FPUDataPointer = 0;
    in_FPUInstructionPointer = 0;
    in_ST0 = (float10)iVar11;
    in_ST7 = fVar17;
  }
  uVar14 = uVar14 + 1;
code_r0x0051701c:
  out(*unaff_ESI,(short)param_2);
  bVar16 = (byte)uVar14 < *in_EAX;
  pcVar3 = unaff_ESI + 0x1e;
  cVar13 = *pcVar3;
  cVar5 = *pcVar3 + (char)unaff_EBX;
  *pcVar3 = cVar5 + bVar16;
  if ((SCARRY1(cVar13,(char)unaff_EBX) != SCARRY1(cVar5,bVar16)) == *pcVar3 < '\0') {
    *(double *)(param_2 + 0x44) = (double)iVar11;
    *(undefined4 *)(uVar14 - 4) = 0xf;
    *(uint *)(uVar14 - 8) = uVar14 - 4;
                    /* WARNING: Bad instruction - Truncating control flow here */
    halt_baddata();
  }
  *(int *)(unaff_ESI + 1) = unaff_EBP;
  pcVar7 = (code *)swi(3);
  (*pcVar7)();
  return;
}


