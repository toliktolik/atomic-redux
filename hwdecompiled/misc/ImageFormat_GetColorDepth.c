/*
 * Function: ImageFormat_GetColorDepth
 * Address: 004bc7f0
 * Category: misc
 * Generated by Ghidra Bulk Exporter
 */

#include "../heavy_weapon_deluxe.h"


undefined4 __cdecl ImageFormat_GetColorDepth(int param_1,uint param_2,int param_3)

{
  int iVar1;
  int iVar2;
  byte bVar3;
  int iVar4;
  undefined3 extraout_var;
  uint *puVar5;
  undefined4 uVar6;
  void *extraout_ECX;
  void *extraout_ECX_00;
  void *extraout_ECX_01;
  void *extraout_ECX_02;
  void *this;
  void *this_00;
  void *extraout_ECX_03;
  int iVar7;
  void *pvVar8;
  void *extraout_ECX_04;
  void *this_01;
  undefined4 extraout_ECX_05;
  void *this_02;
  void *this_03;
  int *piVar9;
  uint extraout_EDX;
  uint uVar10;
  int *piVar11;
  bool bVar12;
  longlong lVar13;
  undefined8 uVar14;
  undefined4 local_50;
  undefined4 local_4c;
  undefined4 local_48;
  undefined4 local_44;
  uint local_40;
  void *local_3c;
  undefined4 local_38;
  undefined4 local_34;
  int local_30 [4];
  int local_20 [5];
  int *local_c;
  uint local_8;
  
  iVar2 = param_1;
  local_20[0] = 0;
  local_20[1] = 0;
  local_20[2] = 0;
  local_20[3] = 0;
  local_50 = 0;
  local_4c = 0;
  local_48 = 0;
  local_44 = 0;
  local_40 = 0;
  local_3c = (void *)0x0;
  local_38 = 0;
  local_34 = 0;
  if (*(int *)(param_1 + 0x40) < 2) {
    return 0xffffff7d;
  }
  if (*(int *)(param_1 + 4) == 0) {
    return 0xffffff76;
  }
  if (((param_3 < 0) || (*(int *)(param_1 + 0x14) < param_3)) ||
     ((*(int *)(param_1 + 0x14) <= param_3 && (*(uint *)(param_1 + 0x10) < param_2)))) {
    return 0xffffff7d;
  }
  *(undefined4 *)(param_1 + 0x38) = 0xffffffff;
  *(undefined4 *)(param_1 + 0x3c) = 0xffffffff;
  CPU_InitializeWithParam
            (*(void **)(param_1 + 0x60),(undefined4 *)*(void **)(param_1 + 0x60),
             *(undefined4 *)(param_1 + 0x44));
  CPU_ProcessData16(param_1 + 0x68);
  ImageFormat_LoadBMP(param_2,param_3);
  param_1 = 0;
  local_8 = 0;
  local_c = (int *)CPU_AllocateContext(*(undefined4 *)(iVar2 + 0x44));
  pvVar8 = extraout_ECX;
  piVar11 = local_c;
LAB_004bc8b0:
  while ((2 < *(int *)(iVar2 + 0x40) &&
         (iVar4 = CPU_ExecuteWithBufferWrapper(&local_50), pvVar8 = extraout_ECX_00, 0 < iVar4))) {
    iVar4 = *(int *)(iVar2 + 0x48) * 0x20;
    if (*(int *)(*(int *)(iVar2 + 0x30) + 0x1c + iVar4) == 0) {
      CPU_ExecuteWithBufferWrapper((void *)0x0);
      pvVar8 = extraout_ECX_02;
      break;
    }
    iVar4 = CPU_ProcessData10(*(int *)(iVar2 + 0x30) + iVar4,&local_50);
    if (iVar4 < 0) {
      CPU_ExecuteWithBufferWrapper(extraout_ECX_01);
      iVar4 = 0;
    }
    else if (local_20[4] == 0) {
      if (param_1 != 0) {
        local_8 = local_8 + (iVar4 + param_1 >> 2);
      }
    }
    else {
      CPU_ExecuteWithBufferWrapper(extraout_ECX_01);
    }
    pvVar8 = local_3c;
    piVar11 = local_c;
    param_1 = iVar4;
    if ((local_40 & (uint)local_3c) != 0xffffffff) {
      iVar4 = *(int *)(iVar2 + 0x48);
      iVar1 = *(int *)(iVar2 + 0x2c);
      puVar5 = (uint *)(iVar4 * 0x10 + iVar1);
      uVar10 = local_40 - *puVar5;
      iVar7 = (int)local_3c + (-(uint)(local_40 < *puVar5) - *(int *)(iVar4 * 0x10 + 4 + iVar1));
      if ((iVar7 < 1) && (iVar7 < 0)) {
        uVar10 = 0;
        iVar7 = 0;
      }
      if (0 < iVar4) {
        puVar5 = (uint *)(iVar1 + 8);
        do {
          bVar12 = CARRY4(uVar10,*puVar5);
          uVar10 = uVar10 + *puVar5;
          iVar7 = iVar7 + puVar5[1] + (uint)bVar12;
          puVar5 = puVar5 + 4;
          iVar4 = iVar4 + -1;
        } while (iVar4 != 0);
      }
      pvVar8 = (void *)((iVar7 - ((int)local_8 >> 0x1f)) - (uint)(uVar10 < local_8));
      *(uint *)(iVar2 + 0x38) = uVar10 - local_8;
      *(void **)(iVar2 + 0x3c) = pvVar8;
LAB_004bcae5:
      CPU_ClearContext8(pvVar8,&local_50);
      CPU_ClearContext4(this_02,local_20);
      CPU_CleanupContext(this_03,piVar11);
      *(undefined4 *)(iVar2 + 0x50) = 0;
      *(undefined4 *)(iVar2 + 0x54) = 0;
      *(undefined4 *)(iVar2 + 0x58) = 0;
      *(undefined4 *)(iVar2 + 0x5c) = 0;
      return 0;
    }
  }
  if (param_1 == 0) {
    lVar13 = ImageFormat_LoadJPEG(local_20,0xffffffff,-1);
    if (-1 < lVar13) {
      if (*(int *)(iVar2 + 0x40) < 3) {
LAB_004bc9bf:
        iVar4 = CPU_ExecuteInstruction14();
        pvVar8 = (void *)0x0;
        *(int *)(iVar2 + 0x44) = iVar4;
        if (0 < (int)*(void **)(iVar2 + 0x1c)) {
          piVar9 = *(int **)(iVar2 + 0x28);
          do {
            if (*piVar9 == iVar4) break;
            pvVar8 = (void *)((int)pvVar8 + 1);
            piVar9 = piVar9 + 1;
          } while ((int)pvVar8 < *(int *)(iVar2 + 0x1c));
        }
        if (pvVar8 == *(void **)(iVar2 + 0x1c)) {
          CPU_ClearContext8(pvVar8,&local_50);
          CPU_ClearContext4(local_20,local_20);
          *(undefined4 *)(iVar2 + 0x38) = 0xffffffff;
          *(undefined4 *)(iVar2 + 0x3c) = 0xffffffff;
          CPU_CleanupContext(this_01,piVar11);
          ImageFormat_SavePNG(extraout_ECX_05,extraout_EDX);
          return 0xffffff77;
        }
        *(void **)(iVar2 + 0x48) = pvVar8;
        CPU_InitializeWithParam
                  (*(void **)(iVar2 + 0x60),(undefined4 *)*(void **)(iVar2 + 0x60),iVar4);
        CPU_InitializeWithParam(this_00,piVar11,*(undefined4 *)(iVar2 + 0x44));
        *(undefined4 *)(iVar2 + 0x40) = 3;
      }
      else {
        uVar14 = CPU_ExecuteInstruction14();
        if (*(int *)(iVar2 + 0x44) != (int)uVar14) {
          ImageFormat_SavePNG(*(int *)(iVar2 + 0x44),(uint)((ulonglong)uVar14 >> 0x20));
          CPU_CleanupContext(this,piVar11);
        }
        if (*(int *)(iVar2 + 0x40) < 3) goto LAB_004bc9bf;
      }
      CPU_CopyContext(local_30,local_20);
      bVar3 = CPU_GetAuxCarryFlag();
      local_20[4] = CONCAT31(extraout_var,bVar3);
      CPU_ValidateAndProcess(*(int **)(iVar2 + 0x60),local_20);
      CPU_ValidateAndProcess(piVar11,local_30);
      pvVar8 = extraout_ECX_03;
      goto LAB_004bc8b0;
    }
    lVar13 = ImageFormat_GetChannelCount(iVar2,-1);
    uVar6 = (undefined4)lVar13;
    *(int *)(iVar2 + 0x3c) = (int)((ulonglong)lVar13 >> 0x20);
    pvVar8 = extraout_ECX_04;
  }
  else {
    uVar6 = 0xffffffff;
    *(undefined4 *)(iVar2 + 0x3c) = 0xffffffff;
  }
  *(undefined4 *)(iVar2 + 0x38) = uVar6;
  goto LAB_004bcae5;
}


